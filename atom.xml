<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>NekoDaemon&#39;s Blog</title>
  
  
  <link href="https://nekodaemon.com/atom.xml" rel="self"/>
  
  <link href="https://nekodaemon.com/"/>
  <updated>2022-10-03T19:20:47.395Z</updated>
  <id>https://nekodaemon.com/</id>
  
  <author>
    <name>NekoDaemon</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Easy ways to setup Reverse Proxy for NAT-Passthrough</title>
    <link href="https://nekodaemon.com/2022/10/03/Easy-ways-to-setup-Reverse-Proxy-for-NAT-Passthrough/"/>
    <id>https://nekodaemon.com/2022/10/03/Easy-ways-to-setup-Reverse-Proxy-for-NAT-Passthrough/</id>
    <published>2022-10-03T11:12:20.000Z</published>
    <updated>2022-10-03T19:20:47.395Z</updated>
    
    <content type="html"><![CDATA[<p>It's time to abandon NPS, Frp, or other solutions that are hard to configure or no longer maintained. Thanks to Docker, it's possible to set up a reliable reverse proxy with single command.</p><h2 id="prerequisite">Prerequisite</h2><p>Make sure you have a machine with a public IP address (it could be a VPS), otherwise our method may not be applicable. Let's take exposing the SSH port of a machine behind NAT as an example. There are three roles in total:</p><ul><li>Local Machine: The machine behind NAT firewall with a local IP address, and you want to expose its SSH port 22 to the public network.</li><li>Public Server: The machine with a public IP address (a.b.c.d). Typically you rent it from a public cloud service provider like AWS or Azure. Its port 22 is also open and being used by its own SSH service.</li><li>Your Computer: Another machine you are currently using.</li></ul><h2 id="recommended-persistent-method-via-gost-with-docker">(Recommended) Persistent Method: via Gost with Docker</h2><h3 id="before-getting-started-install-docker">Before getting started: Install Docker</h3><p>The first step is to install the Docker on both <strong>the local machine</strong> and <strong>the public server</strong>. For Ubuntu 18.04+, I personally prefer to install Docker through apt.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local-machine&amp;public-server$ sudo apt update</span><br><span class="line">local-machine&amp;public-server$ sudo apt install docker.io -y</span><br></pre></td></tr></table></figure><h3 id="recommended-using-websocket-tls-gost-relay-protocol">(Recommended) Using Websocket + TLS + Gost Relay Protocol</h3><p>Gost supports nuermous proxy protocols. For reliablity, it is suggested to use a secured protocol to resist the interference by some secure gateways like GFW. Luckily, with the help of Docker, it is very easy to set up a secured tunnel. Another good news is that Docker Daemon will help to monitor the service and automatically restart Gost Service at boot or on failure. Let's say goodbye to the annoying Systemd.</p><p><strong>On Public Server</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~ <span class="comment"># other any other path you like</span></span><br><span class="line">mkdir gost</span><br><span class="line">docker run --name gost_server --net host -v $(<span class="built_in">pwd</span>)/gost:/root -id --restart always --entrypoint <span class="string">&quot;&quot;</span> -w <span class="string">&quot;/root&quot;</span> gogost/gost gost -L <span class="string">&quot;relay+wss://&lt;user&gt;:&lt;passwd&gt;@:&lt;gost_service_port&gt;?bind=true&quot;</span></span><br></pre></td></tr></table></figure><p><strong>On Local Machine</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name gost_client --net host -id --restart always --entrypoint <span class="string">&quot;&quot;</span>  gogost/gost gost -L rtcp://:&lt;remote_port&gt;/:&lt;local_port&gt; -F <span class="string">&quot;relay+wss://&lt;user&gt;:&lt;passwd&gt;@&lt;pub_server_ip_or_domain&gt;:&lt;gost_service_port&gt;&quot;</span></span><br></pre></td></tr></table></figure><p>Here is the explanation of parameters:</p><ul><li><code>user</code> / <code>passwd</code>: The username and the password for Gost. They are irrelevant to any other account such as Linux accounts.</li><li><code>pub_server_ip_or_domain</code>: It could be either the public IP address or the binded domain name. If you would like to use your valid SSL certificate issued by CA, you should only use the domain name here.</li><li><code>gost_service_port</code>: Could be arbitrary value. It is also fine to set this port number to 443 to pretend as a HTTPS server.</li><li><code>remote_port</code>: The port that the public server's Gost listens to. The data received from this port will be forwarded to <code>local_port</code> on the local machine. It could be arbitrary value.</li><li><code>local_port</code>: The port that should associate with some services on the local machine. In our case, it should be 22, the SSH port.</li></ul><p>Back to our case, the corresponding commands will be:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># On Public Server</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">mkdir gost</span><br><span class="line">docker run --name gost_server --net host -v $(<span class="built_in">pwd</span>)/gost:/root -id --restart always --entrypoint <span class="string">&quot;&quot;</span> -w <span class="string">&quot;/root&quot;</span> gogost/gost gost -L <span class="string">&quot;relay+wss://user:pass@:1234?bind=true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># On Local Machine</span></span><br><span class="line">docker run --name gost_client --net host -id --restart always --entrypoint <span class="string">&quot;&quot;</span>  gogost/gost gost -L rtcp://:2022/:22 -F <span class="string">&quot;relay+wss://user:pass@a.b.c.d:1234&quot;</span> <span class="comment"># a.b.c.d is the public IP of the public server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">docker run --name gost_client --net host -id --restart always --entrypoint <span class="string">&quot;&quot;</span>  gogost/gost gost -L rtcp://:2022/:22 -F <span class="string">&quot;relay+wss://user:pass@mydomain.com:1234&quot;</span> <span class="comment"># mydomain.com can be parsed to a.b.c.d</span></span><br></pre></td></tr></table></figure><p>After that, the SSH port 22 on the local machine should be mapped to the port 2022 on the public server now.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user-local is the name of the user on local machine</span></span><br><span class="line">your-computer$ ssh user-local@a.b.c.d -p 2022</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">your-computer$ ssh user-local@mydomain.com -p 2022</span><br></pre></td></tr></table></figure><blockquote><p><strong>Debugging Tips:</strong> If Gost is not working properly, we can read the log using the command below.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f gost_server <span class="comment"># or gost_client</span></span><br></pre></td></tr></table></figure></blockquote><h4 id="optional-using-your-ssl-certificate">(Optional) Using your SSL certificate</h4><p>By default, Gost will generate a self-signed SSL certificate if the user doesn't specify one. However, this might be considered unsafe as the communication is no longer able to defense the MITM attack. Moreover, some secure gateways may disrupt the TLS session with a self-signed certificate.</p><p>The solution is simple. Do you remember the <code>gost</code> directory we created before? We just need to put our certificate there and restart the service. There should be two files in total, <code>cert.pem</code> and <code>key.pem</code>, and their content should start with <code>-----BEGIN CERTIFICATE----</code> and <code>-----BEGIN RSA PRIVATE KEY-----</code> respectively.</p><p>Lastly, the command to restart the service is:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># On Public Server</span></span><br><span class="line">docker restart gost_server</span><br></pre></td></tr></table></figure><h2 id="temporary-method-via-openssh-client">Temporary Method: via OpenSSH Client</h2><p>If you don't want to install any new software, we can also utilize SSH to build a tunnel. This method is also simple (sometimes), but it is not quite reliable. As you might know, a SSH connection can be easily disrupted due to many reasons. In our case, we just need to type this command on the local machine to set up a tunnel:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local-machine$ ssh -R <span class="string">&quot;[::]:2022:localhost:22&quot;</span> user-public@a.b.c.d</span><br><span class="line"><span class="comment"># a.b.c.d is the public IP, user-public is the name of the user on public server</span></span><br></pre></td></tr></table></figure><p>If everything goes well, now you can connect to the local machine through:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">your-computer$ ssh user-local@a.b.c.d -p 2022</span><br><span class="line"><span class="comment"># user-local is the name of the user on local machine</span></span><br></pre></td></tr></table></figure><p>However, if you failed to connect to your local machine. Please check the <code>sshd</code> configuration on the public server.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public-server$ sudo nano /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><p>Find the following line (for nano editor, press Ctrl-W to search), uncomment, and replaced <code>no</code> with <code>yes</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Before</span></span><br><span class="line"><span class="comment">#GatewayPorts no</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># After</span></span><br><span class="line">GatewayPorts yes</span><br></pre></td></tr></table></figure><p>Then restart the SSH server.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public-server$ sudo service sshd restart</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;It&#39;s time to abandon NPS, Frp, or other solutions that are hard to configure or no longer maintained. Thanks to Docker, it&#39;s possible to set up a reliable reverse proxy with single command.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Slurm Quick Installation for Cluster on Ubuntu 20.04</title>
    <link href="https://nekodaemon.com/2022/09/02/Slurm-Quick-Installation-for-Cluster-on-Ubuntu-20-04/"/>
    <id>https://nekodaemon.com/2022/09/02/Slurm-Quick-Installation-for-Cluster-on-Ubuntu-20-04/</id>
    <published>2022-09-02T04:17:16.000Z</published>
    <updated>2022-09-04T20:24:41.591Z</updated>
    
    <content type="html"><![CDATA[<p>Slurm will make a bunch of seperated machines look much like a cluster, is it right?</p><h2 id="naming-convention-of-nodes">Naming Convention of Nodes</h2><p>A common cluster should comprise management nodes and compute nodes. This aritcle will take our cluster as an example to demostrate steps to install and configure Slurm. In our case, the management node is called <code>clab-mgt01</code> while the compute nodes are named from <code>clab01</code> to <code>clab20</code> in order.</p><h2 id="install-dependencies">Install Dependencies</h2><p>Execute the following command to install the dependencies <strong>on all machines</strong>. (<code>clab-all</code> refers to all machines including management and compute nodes).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clab-all$ sudo apt install slurm-wlm slurm-client munge</span><br></pre></td></tr></table></figure><blockquote><p>Tips: There are several tools that may help to manage multiple nodes easily:</p><ul><li>iTerm2 (on Mac) / Terminator (on Linux)</li><li>csshX (on Mac) / cssh (on Linux)</li><li>Parallel SSH (at cluster side)</li></ul></blockquote><h2 id="generate-slurm-configuration">Generate Slurm Configuration</h2><p>There is <a href="https://slurm.schedmd.com/configurator.html">an official online configuration generator</a>. And we should carefully check the fields below.</p><ul><li><strong>SlurmctldHost</strong>: <code>clab-mgt01</code> in our case.</li><li><strong>NodeName</strong>: <code>clab[01-20]</code> in our case.</li><li><strong>CPUs</strong>: It is recommended to leave it blank.</li><li><strong>Sockets</strong>: For a dual-socket server we commonly see, it should be <code>2</code>.</li><li><strong>CoresPerSocket</strong>: Number of physical cores per socket.</li><li><strong>ThreadsPerCore</strong>: For a regular x86 server, if hyperthreading is enabled, it should be <code>2</code>, otherwise <code>1</code>.</li><li><strong>RealMemory</strong>: Optional.</li></ul><p>Click <code>submit</code>, then we could copy the file content to <code>/etc/slurm-llnl/slurm.conf</code> <strong>on all machines</strong>.</p><blockquote><p>Tips: Don't forget the shared storage (e.g. NFS storage) on the cluster. We could utilize it to distribute files.</p></blockquote><h2 id="distribute-munge-key">Distribute Munge Key</h2><p>Once Munge is installed successfully, the key <code>/etc/munge/munge.key</code> will be automatically generated. It is requried for all machines to hold the same key. Therefore, we could distribute the key <strong>on the management node</strong> to <strong>the remaining nodes</strong> including compute nodes and other backup management node if existing.</p><blockquote><p>Tips: Again. We could also utilize the shared storage to distribute the key.</p></blockquote><p>Then make sure the permission and the ownership are correctly set.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clab-all$ sudo chmod 400 /etc/munge/munge.key</span><br><span class="line">clab-all$ chown munge:munge /etc/munge/munge.key</span><br></pre></td></tr></table></figure><h2 id="patch-slurm-cgroup-integration">Patch Slurm Cgroup Integration</h2><p>By default, there Slurm cannot work with Cgroup well. If we start Slurm service right now, we may receive this error shown below.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: cgroup namespace <span class="string">&#x27;freezer&#x27;</span> not mounted. aborting</span><br></pre></td></tr></table></figure><p>Therefore, by pasting the following content to <code>/etc/slurm/cgroup.conf</code> <strong>on compute nodes</strong>, this issue can be fixed.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CgroupMountpoint=/sys/fs/cgroup</span><br></pre></td></tr></table></figure><p>or using this command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> CgroupMountpoint=/sys/fs/cgroup &gt;&gt; /etc/slurm/cgroup.conf</span><br></pre></td></tr></table></figure><h2 id="fix-directory-permission">Fix Directory Permission</h2><p>For unknown reasons, the permission of the relevant directory is not set properly, which may lead to this error.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slurmctld: fatal: mkdir(/var/spool/slurmctld): Permission denied</span><br></pre></td></tr></table></figure><p>The solution is executing the commands below <strong>on management nodes</strong>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clab-mgt$ sudo mkdir -p /var/spool/slurmctld</span><br><span class="line">clab-mgt$ sudo chown slurm:slurm /var/spool/slurmctld/</span><br></pre></td></tr></table></figure><h2 id="start-slurm-service">Start Slurm Service</h2><p>So far, we have finished the basic configuration. Let us launch Slurm now.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># On management nodes</span></span><br><span class="line">clab-mgt$ sudo systemctl <span class="built_in">enable</span> munge</span><br><span class="line">clab-mgt$ sudo systemctl start munge</span><br><span class="line">clab-mgt$ sudo systemctl <span class="built_in">enable</span> slurmctld</span><br><span class="line">clab-mgt$ sudo systemctl start slurmctld</span><br><span class="line"></span><br><span class="line"><span class="comment"># On compute nodes</span></span><br><span class="line">clab-comp$ sudo systemctl <span class="built_in">enable</span> munge</span><br><span class="line">clab-comp$ sudo systemctl start munge</span><br><span class="line">clab-comp$ sudo systemctl <span class="built_in">enable</span> slurmd</span><br><span class="line">clab-comp$ sudo systemctl start slurmd</span><br></pre></td></tr></table></figure><p>Run <code>sinfo</code> and we should see all the compute nodes are ready.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sinfo</span><br><span class="line">PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST</span><br><span class="line">debug*       up   infinite     20   idle clab[01-20]</span><br></pre></td></tr></table></figure><h2 id="debugging-tips">Debugging Tips</h2><p>If your Slurm is not working correctly, you could try with these commands to debug.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clab-mgt$ sudo slurmctld -D</span><br><span class="line">clab-comp$ sudo slurmd -D</span><br></pre></td></tr></table></figure><h2 id="references">References</h2><ul><li><a href="https://www.cnblogs.com/aobaxu/p/16195237.html">https://www.cnblogs.com/aobaxu/p/16195237.html</a></li><li><a href="https://stackoverflow.com/questions/62641323/error-cgroup-namespace-freezer-not-mounted-aborting">https://stackoverflow.com/questions/62641323/error-cgroup-namespace-freezer-not-mounted-aborting</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Slurm will make a bunch of seperated machines look much like a cluster, is it right?&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Tips of configuring InfiniBand adapters</title>
    <link href="https://nekodaemon.com/2022/08/31/Tips-of-configuring-InfiniBand-Adapters/"/>
    <id>https://nekodaemon.com/2022/08/31/Tips-of-configuring-InfiniBand-Adapters/</id>
    <published>2022-08-30T16:35:51.000Z</published>
    <updated>2022-08-31T11:33:36.107Z</updated>
    
    <content type="html"><![CDATA[<p>After reconfiguring clusters from scratch for several times, it seems that I am gradually adapting to this mystery and strange InfiniBand world...</p><h2 id="relationship-among-infiniband-roce-ipoib-and-ethernet-mode">Relationship among InfiniBand, RoCE, IPoIB, and Ethernet Mode</h2><p>Let us take Mellanox ConnectX Adapter as an example. Actually, this adapter can work in either InfiniBand Mode or Ethernet Mode, which is configurable with some tools provided by the vendor. As iWARP is not widely adopted, our article will not discuss this protocol.</p><table><colgroup><col style="width: 45%" /><col style="width: 30%" /><col style="width: 23%" /></colgroup><thead><tr class="header"><th></th><th>InfiniBand Mode</th><th>Ethernet Mode</th></tr></thead><tbody><tr class="odd"><td>Supported by ConnectX</td><td>Yes</td><td>Yes</td></tr><tr class="even"><td>RDMA Support</td><td>Yes</td><td>Yes</td></tr><tr class="odd"><td>Programmable with Verbs</td><td>Yes</td><td>Yes</td></tr><tr class="even"><td>TCP/IP Support</td><td>Needs IPoIB</td><td>Yes</td></tr><tr class="odd"><td>Configurable with Netplan (e.g. Assign IP Address)</td><td>Needs IPoIB</td><td>Yes</td></tr><tr class="even"><td>Layout of RDMA Packet</td><td>IB Frame + IB Header</td><td>ETH Frame + RoCE Header</td></tr><tr class="odd"><td>Layout of TCP Packet</td><td>IB Frame + IB/IPoIB/IP/TCP Headers</td><td>ETH Frame + IP/TCP Headers</td></tr></tbody></table><p>Note that RoCE Header is a general concept. And RoCEv1 and RoCEv2 give different detailed definitions of this part.</p><h2 id="identify-infiniband-ethernet-mode">Identify InfiniBand / Ethernet Mode</h2><p>The easiest way is to directly have a look at the interface name and link type with <code>ifconfig</code> or <code>ip</code> under Linux. An InfiniBand adapter working in Ethernet mode looks exactly the same as a regular Ethernet adapter.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ip a</span><br><span class="line"><span class="comment"># InfiniBand Mode</span></span><br><span class="line">4: ibp129s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 2044 qdisc mq state UP group default qlen 256</span><br><span class="line">    link/infiniband ...</span><br><span class="line">    inet 192.168.7.100/24 brd 192.168.7.255 scope global ibp129s0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ethernet Mode</span></span><br><span class="line">7: ens1f1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether ...</span><br><span class="line">    inet 10.200.0.1/24 brd 10.200.0.255 scope global ens1f1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Besides, <code>ibdev2netdev</code> can also help.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ibdev2netdev</span><br><span class="line">mlx4_0 port 1 ==&gt; ibp129s0 (Up)</span><br><span class="line">mlx5_0 port 1 ==&gt; ens1f0 (Up)</span><br></pre></td></tr></table></figure><p>Another approach is through <code>ibstat</code>. And the field <code>Link layer</code> shows which mode the adapter is working in.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ ibstat</span><br><span class="line"><span class="comment"># InfiniBand Mode</span></span><br><span class="line">CA <span class="string">&#x27;mlx4_0&#x27;</span></span><br><span class="line">CA <span class="built_in">type</span>: MT4099</span><br><span class="line">Number of ports: 1</span><br><span class="line">Firmware version: 2.42.5000</span><br><span class="line">Hardware version: 1</span><br><span class="line">Node GUID: </span><br><span class="line">System image GUID: </span><br><span class="line">Port 1:</span><br><span class="line">State: Active</span><br><span class="line">Physical state: LinkUp</span><br><span class="line">Rate: 56</span><br><span class="line">Base lid: 1</span><br><span class="line">LMC: 0</span><br><span class="line">SM lid: 1</span><br><span class="line">Capability mask: 0x0251486a</span><br><span class="line">Port GUID: </span><br><span class="line">Link layer: InfiniBand</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ethernet Mode</span></span><br><span class="line">CA <span class="string">&#x27;mlx5_0&#x27;</span></span><br><span class="line">CA <span class="built_in">type</span>: MT4119</span><br><span class="line">Number of ports: 1</span><br><span class="line">Firmware version: 16.25.1020</span><br><span class="line">Hardware version: 0</span><br><span class="line">Node GUID: </span><br><span class="line">System image GUID: </span><br><span class="line">Port 1:</span><br><span class="line">State: Active</span><br><span class="line">Physical state: LinkUp</span><br><span class="line">Rate: 100</span><br><span class="line">Base lid: 0</span><br><span class="line">LMC: 0</span><br><span class="line">SM lid: 0</span><br><span class="line">Capability mask: 0x00010000</span><br><span class="line">Port GUID: </span><br><span class="line">Link layer: Ethernet</span><br></pre></td></tr></table></figure><h2 id="change-infiniband-ethernet-mode">Change InfiniBand / Ethernet Mode</h2><p>To alter the work mode, there doesn't exist a general way for now. For Mellanox ConnectX Adapter, the vendor provided a tool called <code>mlxconfig</code>. Here is the usage listed in <a href="https://docs.nvidia.com/networking/display/MFTv4110/Using+mlxconfig">the official document</a>, where you can find more information about it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mlxconfig -d /dev/mst/mt4103_pci_cr0 <span class="built_in">set</span> LINK_TYPE_P1=1 LINK_TYPE_P2=1</span><br><span class="line"> </span><br><span class="line">Device <span class="comment">#1:</span></span><br><span class="line">----------</span><br><span class="line">Device <span class="built_in">type</span>:   ConnectX3Pro</span><br><span class="line">PCI device:    /dev/mst/mt4103_pci_cr0</span><br><span class="line">Configurations:        Next Boot        New</span><br><span class="line">  LINK_TYPE_P1         ETH(2)           IB(1)</span><br><span class="line">  LINK_TYPE_P2         ETH(2)           IB(1)</span><br><span class="line"> </span><br><span class="line">Apply new Configuration? ? (y/n) [n] : y</span><br><span class="line">Applying... Done!</span><br><span class="line">-I- Please reboot machine to load new configurations.</span><br></pre></td></tr></table></figure><p>Note that P1 and P2 are referring to two separated ports on the adapter. <strong>Attention: Please make sure the network switch is capable of handling InfiniBand or Ethernet Frame before altering the work mode .</strong> If the switch cannot recognize the data frame sent from the server, you might observer <code>Physical state: Polling</code> reported by <code>ibstat</code>, as the packet is not forwarded by the switch correctly. Certain network switches can only forward one type of data frame at a time, which means you may need to manually reconfigure the switch to let it work with the other type of data frame.</p><h2 id="configure-ipoib">Configure IPoIB</h2><p>By default, the IPoIB will be automatically configured when the IP address is assigned to the interface. The IP address can be managed by <code>netplan</code> or <code>NetworkManager</code>, which depends on your Linux distro. As for the configuration file, there is no difference between the InfiniBand and regular Ethernet Adapters.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assign a static IP address with netplan for an InfiniBand interface</span></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">ibp129s0:</span></span><br><span class="line">      <span class="attr">addresses:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.7</span><span class="number">.100</span><span class="string">/24</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>Once the above configuration is applied and the interface is brought up successfully. We can see <code>ib_ipoib</code> module is loaded.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ lsmod | grep ipoib</span><br><span class="line">ib_ipoib              180224  0</span><br><span class="line">$ ip a</span><br><span class="line">4: ibp129s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 2044 qdisc mq state UP group default qlen 256</span><br><span class="line">    link/infiniband ...</span><br><span class="line">    inet 192.168.7.100/24 brd 192.168.7.255 scope global ibp129s0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>If the IP address doesn't appear in <code>ip a</code>, we need to check the status of the InfiniBand adapter and make sure its state is active in <code>ibstat</code>. A common mistake is forgetting to enable <code>opensm</code> / <code>opensmd</code>, which will make the adapter stuck at <code>State: Initializing</code>. Note that <code>opensmd</code> will not launch on startup by default.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start OpenSM</span></span><br><span class="line">$ sudo opensm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start OpenSM As Daemon</span></span><br><span class="line">$ sudo service opensmd start <span class="comment"># Method 1</span></span><br><span class="line">$ sudo systemctl start opensmd <span class="comment"># Method 2</span></span><br><span class="line">$ sudo /etc/init.d/opensmd start <span class="comment"># Method 3</span></span><br></pre></td></tr></table></figure><h2 id="identify-roce-version">Identify RoCE Version</h2><p>The major difference between RoCEv1 and RoCEv2 is that RoCEv2 is able to utilize IP networking to route while RoCEv1 is routing via MAC addresses. A funny fact is RoCEv1 and RoCEv2 may be enable simultaneously, and we could choose the version at runtime through specifying Group ID (GID). There is a script written by Mellanox named <code>show_gids</code> and it will display RoCE versions associated to GIDs.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ show_gids</span><br><span class="line">DEVPORTINDEXGIDIPv4  VERDEV</span><br><span class="line">---------------------------  ------</span><br><span class="line">mlx5_010fe80:0000:0000:0000:...v1ens1f0</span><br><span class="line">mlx5_011fe80:0000:0000:0000:...v2ens1f0</span><br><span class="line">mlx5_0120000:0000:0000:0000:...11.0.0.201  v1ens1f0</span><br><span class="line">mlx5_0130000:0000:0000:0000:...11.0.0.201  v2ens1f0</span><br></pre></td></tr></table></figure><h2 id="check-adapter-speed">Check Adapter Speed</h2><p><code>ethtool</code> can read out this information and it can work with both InfiniBand and Ethernet mode.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool ibp129s0</span><br><span class="line">Settings <span class="keyword">for</span> ibp129s0:</span><br><span class="line">...</span><br><span class="line">Speed: 56000Mb/s</span><br><span class="line">Duplex: Full</span><br><span class="line"></span><br><span class="line">$ ethtool ens1f0</span><br><span class="line">Settings <span class="keyword">for</span> ens1f0:</span><br><span class="line">...</span><br><span class="line">Speed: 100000Mb/s</span><br><span class="line">Duplex: Full</span><br></pre></td></tr></table></figure><h2 id="references">References</h2><ul><li><a href="https://www.advancedclustering.com/act_kb/infiniband-port-states/">https://www.advancedclustering.com/act_kb/infiniband-port-states/</a></li><li><a href="https://zhuanlan.zhihu.com/p/32105832">https://zhuanlan.zhihu.com/p/32105832</a></li><li><a href="https://wiki.archlinux.org/title/InfiniBand">https://wiki.archlinux.org/title/InfiniBand</a></li><li><a href="https://docs.nvidia.com/networking/display/MLNXOFEDv461000/OpenSM">https://docs.nvidia.com/networking/display/MLNXOFEDv461000/OpenSM</a></li><li><a href="https://www.cnblogs.com/juzib/p/13273380.html">https://www.cnblogs.com/juzib/p/13273380.html</a></li><li><a href="https://blog.51cto.com/liangchaoxi/4044293">https://blog.51cto.com/liangchaoxi/4044293</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;After reconfiguring clusters from scratch for several times, it seems that I am gradually adapting to this mystery and strange InfiniBand world...&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Building OpenWrt from Scratch for ARM64 UEFI ACPI VM</title>
    <link href="https://nekodaemon.com/2022/02/26/Building-OpenWrt-from-Scratch-for-ARM64-UEFI-ACPI-VM/"/>
    <id>https://nekodaemon.com/2022/02/26/Building-OpenWrt-from-Scratch-for-ARM64-UEFI-ACPI-VM/</id>
    <published>2022-02-26T09:34:48.000Z</published>
    <updated>2022-02-26T18:16:15.842Z</updated>
    
    <content type="html"><![CDATA[<p>OpenWrt doesn't provide a combined disk image for ARM virtual machines, unlike what they did for x86 VMs. Meanwhile, their official ARM64 kernel release can't boot in UEFI environment. But we can still make it work by compiling it from source and building a disk image manually.</p><p>Since Arm community has various opinions on how to boot an Arm machine, such as UEFI + ACPI (widely used by commercial Arm servers as well as modern x86 systems), U-Boot + Device Tree (mostly used by embedded devices with limited resouces), and even UEFI + Device Tree (like Huawei L420 notebook I owned), I would suggest that don't expect OpenWrt will provide official support for UEFI + ACPI systems in recent days as it is designed to run on tiny routers.</p><h2 id="compile-kernel-and-rootfs-from-source">Compile Kernel and Rootfs from Source</h2><p>Don't be scared. With the help of <code>buildroot</code>, which could automatically prepare the cross-compilation toolchain we need, this step is much simple nowadays.</p><blockquote><p>Note: My test environment is Ubuntu 21.10 ARM64 on Apple M1 Pro. It doesn't matter if you use a machine with a different system or architecture like AMD64, but you may need to take a few extra steps if so.</p></blockquote><h3 id="install-dependencies">Install Dependencies</h3><p>For Debian / Ubuntu users,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install build-essential ccache ecj fastjar file g++ gawk \</span><br><span class="line">gettext git java-propose-classpath libelf-dev libncurses5-dev \</span><br><span class="line">libncursesw5-dev libssl-dev python python2.7-dev python3 unzip wget \</span><br><span class="line">python3-distutils python3-setuptools python3-dev rsync subversion \</span><br><span class="line">swig time xsltproc zlib1g-dev </span><br></pre></td></tr></table></figure><blockquote><p>Note: The content of this sub-section is copied from the <a href="https://openwrt.org/docs/guide-developer/toolchain/install-buildsystem">official guide</a>. Take a look at it if this command is not applicable for your system.</p></blockquote><h3 id="download-the-source-code">Download the Source Code</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.openwrt.org/openwrt/openwrt.git</span><br><span class="line"><span class="built_in">cd</span> openwrt</span><br><span class="line">git tag</span><br><span class="line">git checkout v21.02.2</span><br><span class="line">./scripts/feeds update -a</span><br></pre></td></tr></table></figure><h3 id="configure-the-project">Configure the Project</h3><ol type="1"><li>Import the official configuration.</li></ol><p>To save our effort, it is a good idea to modify an existing configuration instead of creating a new one.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.openwrt.org/releases/21.02.2/targets/armvirt/64/config.buildinfo</span><br><span class="line">cp config.buildinfo .config</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>Add UEFI ACPI support.</li></ol><p>Open file <code>target/linux/armvirt/config-5.4</code>, and append the following lines to the end of file.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_EFI_STUB=y</span><br><span class="line">CONFIG_EFI=y</span><br><span class="line">CONFIG_EFI_VARS=y</span><br><span class="line">CONFIG_ARCH_SUPPORTS_ACPI=y</span><br><span class="line">CONFIG_ACPI=y</span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>Launch Memuconfig.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make kernel_menuconfig</span><br></pre></td></tr></table></figure><p>Tweak the configuration as you like, but you should clearly understand the consequence before you turn on and off something. Keeping default options is also fine.</p><blockquote><p>Note: These commands will build the whole toolchain from source for the first time they are executed. The compilation process is very slow.</p></blockquote><h3 id="build-the-kernel-and-rootfs">Build the Kernel and Rootfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j $(nproc) defconfig download clean world</span><br></pre></td></tr></table></figure><p>It will compile the kernel and all of the selected pre-installed utilities, then generate an EFI binary of Linux Kernel and an Ext4 / SquashFS partition image of Rootfs.</p><h3 id="verify-the-firmware-image">Verify the Firmware Image</h3><p>The exciting moment comes. Let's test the kernel and rootfs we just built.</p><ol type="1"><li>Install QEMU.</li></ol><p>For Ubuntu users, I would suggest to install virt-manager instead, which offers a helpful GUI wizard for QEMU.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install virt-manager</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>Launch a virtual machine.</li></ol><p>The magical QEMU allows virtual machines to boot a kernel without a bootloader. That is a great feature enables us to test the kernel's functionality at the early stage.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-aarch64 -m 512 -nographic -cpu cortex-a72 -smp 1 -M virt -kernel ~/openwrt/bin/targets/armvirt/64/openwrt-21.02.2-armvirt-64-Image-initramfs -bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd</span><br></pre></td></tr></table></figure><blockquote><p>Note: <code>Image-initramfs</code> is the kernel binary while it integrates the OpenWrt's Rootfs as <code>initramfs</code>, so this virtual machine will lose data each time it reboots.</p></blockquote><blockquote><p>Note: If you encounter this issue,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EFI stub: Booting Linux Kernel...</span><br><span class="line">EFI stub: ERROR: Failed to relocate kernel</span><br><span class="line">EFI stub: ERROR: Failed to relocate kernel</span><br></pre></td></tr></table></figure><p>The solution is to increase the memory capacity of your virtual machine. Empirically, it should be at least 256 MB.</p></blockquote><h2 id="build-the-disk-image">Build the Disk Image</h2><p>Considered that data loss is not acceptable, while not every hypervisor is capable of launching a kernel directly, we should put everything we built into a disk, or virtual machine's disk image.</p><p>To keep things simple, let's start from building a raw disk image, which is one of the virtual disk formats supported by QEMU.</p><h3 id="create-an-empty-disk-image">Create an Empty Disk Image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ dd <span class="keyword">if</span>=/dev/zero of=disk.img bs=1M count=1024</span><br><span class="line">1024+0 records <span class="keyword">in</span></span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB, 1.0 GiB) copied, 0.958229 s, 1.1 GB/s</span><br></pre></td></tr></table></figure><p>This command will create an empty disk image. Feel free to replace the value of <code>count</code> to change the size of the disk. (size = 1 MB * 1024 = 1 GB)</p><h3 id="partition-mount-and-format-the-disk-image">Partition, Mount, and Format the Disk Image</h3><ol type="1"><li>Partition the disk.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ fdisk disk.img</span><br><span class="line"></span><br><span class="line">Welcome to fdisk (util-linux 2.36.1).</span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">Device does not contain a recognized partition table.</span><br><span class="line">Created a new DOS disklabel with disk identifier 0xb89701e3.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): g</span><br><span class="line">Created a new GPT disklabel (GUID: 43B50BB3-20FD-3D4B-BFE1-50B5016F8059).</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition number (1-128, default 1):</span><br><span class="line">First sector (2048-2097118, default 2048):</span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-2097118, default 2097118): +100M</span><br><span class="line"></span><br><span class="line">Created a new partition 1 of <span class="built_in">type</span> <span class="string">&#x27;Linux filesystem&#x27;</span> and of size 100 MiB.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): t</span><br><span class="line">Selected partition 1</span><br><span class="line">Partition <span class="built_in">type</span> or <span class="built_in">alias</span> (<span class="built_in">type</span> L to list all): uefi</span><br><span class="line">Changed <span class="built_in">type</span> of partition <span class="string">&#x27;Linux filesystem&#x27;</span> to <span class="string">&#x27;EFI System&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition number (2-128, default 2):</span><br><span class="line">First sector (206848-2097118, default 206848):</span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (206848-2097118, default 2097118):</span><br><span class="line"></span><br><span class="line">Created a new partition 2 of <span class="built_in">type</span> <span class="string">&#x27;Linux filesystem&#x27;</span> and of size 923 MiB.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line">Disk disk.img: 1 GiB, 1073741824 bytes, 2097152 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: gpt</span><br><span class="line">Disk identifier: 43B50BB3-20FD-3D4B-BFE1-50B5016F8059</span><br><span class="line"></span><br><span class="line">Device      Start     End Sectors  Size Type</span><br><span class="line">disk.img1    2048  206847  204800  100M EFI System</span><br><span class="line">disk.img2  206848 2097118 1890271  923M Linux filesystem</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure><p>A new GPT partition table with two partitions is written to the disk image.</p><ol start="2" type="1"><li>Mount the disk image as a logical disk.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo losetup -Pf disk.img</span><br><span class="line">tonny@vm:~$ lsblk</span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop5                       7:5    0    1G  0 loop</span><br><span class="line">loop5p1                 259:4    0  100M  0 part</span><br><span class="line">loop5p2                 259:5    0  923M  0 part</span><br></pre></td></tr></table></figure><p>OS has recognized the two partitions, <code>loop5p1</code> and <code>loop5p2</code>.</p><ol start="3" type="1"><li>Format the partitions.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt$ sudo mkfs.vfat /dev/loop5p1</span><br><span class="line">mkfs.fat 4.2 (2021-01-31)</span><br></pre></td></tr></table></figure><p>We don't need to format the second partition (Rootfs) for now, because we can directly restore the partition image of Rootfs instead, which is already formatted with Ext4 File System.</p><ol start="4" type="1"><li>Mount ESP partition.</li></ol><p>ESP partition contains the EFI executables of bootloaders (e.g., GRUB), as well as its configuration files. We can also put the kernel binary here.</p><blockquote><p>Note: Some Linux distributions, like Ubuntu, will put their kernel in a third partition.</p></blockquote><p>Unlike Rootfs, OpenWrt Build System won't generate an ESP partition image for ARM64 platform. That means we have to build ESP partition manually.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt$ mkdir -p ~/mnt/esp</span><br><span class="line">tonny@vm:~/mnt$ sudo mount /dev/loop5p1 ~/mnt/esp</span><br></pre></td></tr></table></figure><h3 id="restore-rootfs-partition-image">Restore Rootfs Partition Image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo dd <span class="keyword">if</span>=~/openwrt/bin/targets/armvirt/64/openwrt-21.02.2-armvirt-64-rootfs-ext4.img of=/dev/loop5p2 bs=1M</span><br><span class="line">104+0 records <span class="keyword">in</span></span><br><span class="line">104+0 records out</span><br><span class="line">109051904 bytes (109 MB, 104 MiB) copied, 0.613318 s, 178 MB/s</span><br><span class="line">tonny@vm:~$ sudo resize2fs /dev/loop5p2</span><br><span class="line">resize2fs 1.46.3 (27-Jul-2021)</span><br><span class="line">Resizing the filesystem on /dev/loop5p2 to 236283 (4k) blocks.</span><br><span class="line">The filesystem on /dev/loop5p2 is now 236283 (4k) blocks long.</span><br></pre></td></tr></table></figure><p>The size of Rootfs image is about 128 MB, which implies that the file system inside will assume the partition size is about 128 MB. The size of our Rootfs partition is likely larger than this number, so we should notify the filesystem there is a change on the partition size.</p><h3 id="install-grub-to-esp-partition">Install GRUB to ESP Partition</h3><h4 id="install-arm64-grub-to-host">Install ARM64 GRUB to Host</h4><p>For Ubuntu users,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install grub-efi-arm64-bin</span><br></pre></td></tr></table></figure><blockquote><p>Note: If your Host's architecture isn't ARM64, Apt may fail to find this package. Fortunately, thanks to Multiarch feature, we can easily install a package for other architectures. Take Ubuntu AMD64 as an example.</p><ol type="1"><li>Request for ARM64 architecture's packages.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg --add-architecture arm64</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>Add an Apt Repository for ARM64.</li></ol><p>Modify the file <code>/etc/apt/source.list</code> and add a ARM64 repository. Pay attention that ARM64 and AMD64 don't share the same repository, so we also need to add a filter for each repository. Here is an example.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">deb [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish-security main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish-updates main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=amd64 ] https://mirrors.ustc.edu.cn/ubuntu/ impish-backports main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish-security main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish-security main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish-updates main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish-updates main restricted universe multiverse</span></span><br><span class="line"></span><br><span class="line">deb [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish-backports main restricted universe multiverse</span><br><span class="line"><span class="comment"># deb-src [ arch=arm64 ] https://mirrors.ustc.edu.cn/ubuntu-ports/ impish-backports main restricted universe multiverse</span></span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>Install ARM64 GRUB</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install grub-efi-arm64-bin</span><br></pre></td></tr></table></figure></blockquote><h4 id="generate-efi-executable">Generate EFI Executable</h4><ol type="1"><li>Check Partition's UUIDs.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ lsblk -o PATH,UUID,PARTUUID /dev/loop5</span><br><span class="line">PATH         UUID                                 PARTUUID</span><br><span class="line">/dev/loop5</span><br><span class="line">/dev/loop5p1 CF95-2044                            3754ccb7-1920-2b41-9962-af81ac6a04b2</span><br><span class="line">/dev/loop5p2 ff313567-e9f1-5a5d-9895-3ba130b4a864 e09a20c3-0ea7-0c48-b653-0482facd93db</span><br></pre></td></tr></table></figure><p>Those UUIDs will be referred by the GRUB configurations.</p><ol start="2" type="1"><li>Write Early-stage GRUB Configuration.</li></ol><p>Create a new file <code>~/grub-early.cfg</code>, and write the following lines. This configuration will be hardcoded into GRUB's EFI binary.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search.fs_uuid CF95-2044 root</span><br><span class="line"><span class="built_in">set</span> prefix=(<span class="variable">$root</span>)<span class="string">&#x27;/boot&#x27;</span></span><br><span class="line">configfile <span class="variable">$prefix</span>/grub.cfg</span><br></pre></td></tr></table></figure><p>Replace the UUID with your <code>loop5p1</code>'s.</p><ol start="3" type="1"><li>Make GRUB EFI Executable.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tonny@vm:~$ sudo mount /dev/loop5p1 ~/mnt/esp</span></span><br><span class="line">tonny@vm:~$ sudo mkdir -p ~/mnt/esp/EFI/BOOT/</span><br><span class="line">tonny@vm:~$ <span class="built_in">cd</span> ~/mnt/esp/EFI/BOOT/</span><br><span class="line">tonny@vm:~/mnt/esp/EFI/BOOT$ sudo grub-mkimage -c ~/grub-early.cfg -p /boot -o BOOTAA64.EFI -O arm64-efi boot chain configfile fat linux ls part_gpt reboot serial efi_gop search_fs_uuid</span><br></pre></td></tr></table></figure><blockquote><p>Note: It is not recommended to use <code>grub-install</code> here. One of its typical usages is,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grub-install --target=arm64-efi --efi-directory ~/mnt/esp --bootloader-id=GRUB --boot-directory ~/mnt/esp/boot/</span><br></pre></td></tr></table></figure><p>The hidden disgusting thing is, if you use GRUB provided by Ubuntu, this command will hardcode an important GRUB variable <code>prefix='/EFI/ubuntu'</code> to the EFI binary, and there is no way to change it.</p></blockquote><h4 id="write-second-stage-grub-configuration">Write Second-stage GRUB Configuration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt/esp/EFI/BOOT$ <span class="built_in">cd</span> ../..</span><br><span class="line">tonny@vm:~/mnt/esp$ sudo mkdir boot</span><br><span class="line">tonny@vm:~/mnt/esp$ <span class="built_in">cd</span> boot/</span><br><span class="line">tonny@vm:~/mnt/esp/boot$ sudo nano grub.cfg <span class="comment"># or other text editor you feel comfortable with</span></span><br></pre></td></tr></table></figure><p>The content of <code>grub.cfg</code> is,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1 --rtscts=off</span><br><span class="line">terminal_input console serial; terminal_output console serial</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> default=<span class="string">&quot;0&quot;</span></span><br><span class="line"><span class="built_in">set</span> timeout=<span class="string">&quot;5&quot;</span></span><br><span class="line"></span><br><span class="line">menuentry <span class="string">&quot;OpenWrt&quot;</span> &#123;</span><br><span class="line">linux /boot/vmlinuz root=PARTUUID=e09a20c3-0ea7-0c48-b653-0482facd93db rootwait   console=tty0 console=ttyS0,115200n8 noinitrd</span><br><span class="line">&#125;</span><br><span class="line">menuentry <span class="string">&quot;OpenWrt (failsafe)&quot;</span> &#123;</span><br><span class="line">linux /boot/vmlinuz failsafe=<span class="literal">true</span> root=PARTUUID=e09a20c3-0ea7-0c48-b653-0482facd93db rootwait   console=tty0 console=ttyS0,115200n8 noinitrd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Replace <strong>PARTUUIDs</strong> (not UUIDs) with your <code>loop5p2</code>'s.</p><h3 id="copy-linux-kernel">Copy Linux Kernel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt/esp/boot$ sudo cp ~/openwrt/bin/targets/armvirt/64/openwrt-21.02.2-armvirt-64-Image vmlinuz</span><br></pre></td></tr></table></figure><h3 id="verify-the-disk-image">Verify the Disk Image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt/esp/boot$ <span class="built_in">cd</span> ~</span><br><span class="line">tonny@vm:~$ qemu-system-aarch64 -m 512 -nographic -cpu cortex-a72 -smp 1 -M virt -bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd -drive format=raw,file=disk.img</span><br></pre></td></tr></table></figure><p>If everything goes well, you could see your kernel is running happily. Enjoy it!</p><blockquote><p>Note: You don't have to unmount the disk before launching the virtual machine. But you should sync the disk to make sure all the data cached in memory is written back.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt/esp/boot$ sync</span><br></pre></td></tr></table></figure></blockquote><h3 id="clean-up">Clean up</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt$ sudo umount ~/mnt/esp</span><br><span class="line">tonny@vm:~/mnt$ sudo losetup -d /dev/loop5</span><br></pre></td></tr></table></figure><h2 id="launch-vm-with-virt-manager">Launch VM with Virt-Manager</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~/mnt$ virt-manager</span><br></pre></td></tr></table></figure><blockquote><p>Note: Sometimes <code>vert-manager</code> requires permissions to run.</p></blockquote><p>The recommended configuration:</p><ul><li>Step 1:<ul><li>Architecture: <code>aarch64</code></li><li>Machine Type: <code>virt</code></li><li>Import existing disk image</li></ul></li><li>Step 2:<ul><li>Browse  Add pool <code>Home</code>  Choose Volume <code>disk.img</code></li><li>Choose OS: Generic Linux / OS</li></ul></li><li>Step 3:<ul><li>Memory: &gt;= 256 MB</li><li>CPU: Any</li></ul></li><li>Step 4:<ul><li><strong>Customize configuration before install</strong></li><li>Network (LAN Port): Bridge / Macvtap Bridge</li></ul></li><li>Configuration<ul><li><strong>Overview/Firmware: <code>UEFI aarch64</code></strong></li></ul></li></ul><blockquote><p>Note: You can't change the firmware type after pre-install configuration.</p></blockquote><h2 id="references">References</h2><ul><li><a href="https://gist.github.com/tstellanova/dea7593a7dfe4f48432a58cb007e7056">https://gist.github.com/tstellanova/dea7593a7dfe4f48432a58cb007e7056</a></li><li><a href="https://forum.openwrt.org/t/arm64-armvirt64-uefi-efi-openwrt-target/82740">https://forum.openwrt.org/t/arm64-armvirt64-uefi-efi-openwrt-target/82740</a></li><li><a href="https://forum.openwrt.org/t/how-to-install-openwrt-as-a-new-os-in-the-grub-menu/97465">https://forum.openwrt.org/t/how-to-install-openwrt-as-a-new-os-in-the-grub-menu/97465</a></li><li><a href="https://wiki.ubuntu.com/ARM64/QEMU">https://wiki.ubuntu.com/ARM64/QEMU</a></li><li><a href="https://wiki.archlinux.org/title/GRUB">https://wiki.archlinux.org/title/GRUB</a></li><li><a href="https://openwrt.org/docs/guide-user/virtualization/qemu">https://openwrt.org/docs/guide-user/virtualization/qemu</a></li><li><a href="https://krinkinmu.github.io/2020/11/21/EFI-aarch64.html">https://krinkinmu.github.io/2020/11/21/EFI-aarch64.html</a></li><li><a href="https://soha.moe/post/make-uefi-compatible-openwrt-disk-image.html">https://soha.moe/post/make-uefi-compatible-openwrt-disk-image.html</a></li><li><a href="https://git.openwrt.org/?p=openwrt/openwrt.git;hb=refs/heads/openwrt-21.02;a=blob;f=package/boot/grub2/Makefile">https://git.openwrt.org/?p=openwrt/openwrt.git;hb=refs/heads/openwrt-21.02;a=blob;f=package/boot/grub2/Makefile</a></li><li><a href="https://www.cxyzjd.com/article/u010875635/74289971">https://www.cxyzjd.com/article/u010875635/74289971</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;OpenWrt doesn&#39;t provide a combined disk image for ARM virtual machines, unlike what they did for x86 VMs. Meanwhile, their official ARM64 kernel release can&#39;t boot in UEFI environment. But we can still make it work by compiling it from source and building a disk image manually.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>How to resize the root LVM partition of Ubuntu</title>
    <link href="https://nekodaemon.com/2022/02/26/How-to-resize-the-root-LVM-partition-of-Ubuntu/"/>
    <id>https://nekodaemon.com/2022/02/26/How-to-resize-the-root-LVM-partition-of-Ubuntu/</id>
    <published>2022-02-26T09:32:57.000Z</published>
    <updated>2022-02-26T09:36:05.312Z</updated>
    
    <content type="html"><![CDATA[<p>When we resize the virtual hard disk of a virtual machine or restore a disk image to a larger disk, the free space of the partition detected by Ubuntu will not increase because the partition table is unchanged. In the past, we could easily resize the ext4 root partition with the help of <code>resize2fs</code>. However, things get complex when Ubuntu utilizes LVM partition as their default root partition.</p><h2 id="quick-intro-to-lvm">Quick Intro to LVM</h2><p>Logical Volume Manager (LVM) is similar to Dynamic Disks under Windows, which can take several GPT / MBR partitions on different hard disks as a storage pool (LVM call it Volume Groups, VG), and allocate spaces from this pool, then Linux will recognize each space (LVM call it Logical Volume, LV) as an useable partition.</p><figure><img data-src="/images/pasted-99.png" alt="Lvm Layout" /><figcaption>Lvm Layout</figcaption></figure><p>Thus, we should modify not only <strong>the GPT / MBR partition table</strong>, but also <strong>the LVM configuration</strong>.</p><h2 id="update-gpt-mbr-partition-table">Update GPT / MBR partition table</h2><p><strong>I suggest all the operations should be done under live CD environment to avoid the occurrence of unpredictable problems.</strong> I didn't test online resizing on the root partition so far.</p><ol type="1"><li>The following instructions in this section assume <strong>the last partition on your disk is the LVM Physical Volume</strong>. You could verify this with the command <code>lsblk --fs</code>. <code>nvme0n1p3</code> is the last GPT partition on the disk <code>nvme0n1</code>, and it is easy to identify this partition is a LVM PV, and <code>ubuntu--vg-ubuntu--lv</code> is the corresponding LV.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ lsblk --fs</span><br><span class="line">NAME                      FSTYPE      FSVER        </span><br><span class="line">loop3</span><br><span class="line">loop3p1                 LVM2_member LVM2 001 </span><br><span class="line">  test--vg-test--lv     ext4        1.0      </span><br><span class="line">nvme0n1</span><br><span class="line">nvme0n1p1               vfat        FAT32    </span><br><span class="line">nvme0n1p2               ext4        1.0      </span><br><span class="line">nvme0n1p3               LVM2_member LVM2 001 </span><br><span class="line">  ubuntu--vg-ubuntu--lv ext4        1.0      </span><br></pre></td></tr></table></figure><blockquote><p>Note that <code>ubuntu--vg-ubuntu--lv</code> is the root partition of the system here.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ df -Th</span><br><span class="line">Filesystem                        Type   Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/ubuntu--vg-ubuntu--lv ext4    78G  7.7G   67G  11% /</span><br><span class="line">/dev/nvme0n1p2                    ext4   974M   87M  820M  10% /boot</span><br><span class="line">/dev/nvme0n1p1                    vfat   511M  3.6M  508M   1% /boot/efi</span><br><span class="line">/dev/mapper/test--vg-test--lv     ext4   464M   24K  429M   1% /home/tonny/mnt</span><br></pre></td></tr></table></figure><p>Also you could check the LVM Volume Group status by <code>vgs</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo vgs</span><br><span class="line">  VG        <span class="comment">#PV #LV #SN Attr   VSize   VFree</span></span><br><span class="line">  test-vg     1   1   0 wz--n- 496.00m    0</span><br><span class="line">  ubuntu-vg   1   1   0 wz--n- &lt;78.50g    0</span><br></pre></td></tr></table></figure></blockquote><ol start="2" type="1"><li>Update the GPT / MBR partition table using <code>fdisk</code>. I will use an emulated disk <code>/dev/loop3</code> to demonstrate the whole process. Don't worry, you won't loss your data under normal circumstances. These commands will only modify the partition table, but make sure <strong>DO NOT remove the LVM's signature</strong>, otherwise the system may no longer recognize your LVM PV.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo fdisk /dev/loop3 <span class="comment"># replace with your hard disk, such as /dev/nvme0n1p3</span></span><br><span class="line"></span><br><span class="line">Welcome to fdisk (util-linux 2.36.1).</span><br><span class="line">Changes will remain <span class="keyword">in</span> memory only, until you decide to write them.</span><br><span class="line">Be careful before using the write <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line">Disk /dev/loop3: 1 GiB, 1073741824 bytes, 2097152 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: gpt</span><br><span class="line">Disk identifier: C5F55056-8C56-5448-81E4-567F59AD93ED</span><br><span class="line"></span><br><span class="line">Device       Start     End Sectors  Size Type</span><br><span class="line">/dev/loop3p1  2048 1026047 1024000  500M Linux filesystem</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): d</span><br><span class="line">Selected partition 1</span><br><span class="line">Partition 1 has been deleted.</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition number (1-128, default 1):</span><br><span class="line">First sector (2048-2097118, default 2048):</span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (2048-2097118, default 2097118):</span><br><span class="line"></span><br><span class="line">Created a new partition 1 of <span class="built_in">type</span> <span class="string">&#x27;Linux filesystem&#x27;</span> and of size 1023 MiB.</span><br><span class="line">Partition <span class="comment">#1 contains a LVM2_member signature.</span></span><br><span class="line"></span><br><span class="line">Do you want to remove the signature? [Y]es/[N]o: N</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line"></span><br><span class="line">Disk /dev/loop3: 1 GiB, 1073741824 bytes, 2097152 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: gpt</span><br><span class="line">Disk identifier: C5F55056-8C56-5448-81E4-567F59AD93ED</span><br><span class="line"></span><br><span class="line">Device       Start     End Sectors  Size Type</span><br><span class="line">/dev/loop3p1  2048 2097118 2095071 1023M Linux filesystem</span><br><span class="line"></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered.</span><br><span class="line">Calling ioctl() to re-read partition table.</span><br><span class="line">Syncing disks.</span><br></pre></td></tr></table></figure><h2 id="update-lvm-configuration">Update LVM Configuration</h2><ol type="1"><li>Notify LVM there is an update on the partition table.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo partprobe <span class="comment"># ask kernel to read the new partition table</span></span><br><span class="line">tonny@vm:~$ sudo pvresize /dev/loop3p1 <span class="comment"># replace with your partition</span></span><br><span class="line">  Physical volume <span class="string">&quot;/dev/loop3p1&quot;</span> changed</span><br><span class="line">  1 physical volume(s) resized or updated / 0 physical volume(s) not resized</span><br></pre></td></tr></table></figure><blockquote><p>At this moment, the LVM Volume Group status has changed to,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo vgs</span><br><span class="line">  VG        <span class="comment">#PV #LV #SN Attr   VSize    VFree</span></span><br><span class="line">  test-vg     1   1   0 wz--n- 1020.00m 524.00m</span><br><span class="line">  ubuntu-vg   1   1   0 wz--n-  &lt;78.50g      0</span><br></pre></td></tr></table></figure><p>Observe that <code>VFree</code> of <code>test-vg</code> has increased by 524.00 MB.</p></blockquote><ol start="2" type="1"><li>Resize LVM Logical Volume. The following command will allocate all the free space of VG to the LV.</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo lvextend -l +100%FREE /dev/mapper/test--vg-test--lv</span><br><span class="line">  Size of logical volume test-vg/test-lv changed from 496.00 MiB (124 extents) to 1020.00 MiB (255 extents).</span><br><span class="line">  Logical volume test-vg/test-lv successfully resized.</span><br></pre></td></tr></table></figure><blockquote><p>The free space of VG is used up now.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo vgs</span><br><span class="line">  VG        <span class="comment">#PV #LV #SN Attr   VSize    VFree</span></span><br><span class="line">  test-vg     1   1   0 wz--n- 1020.00m    0</span><br><span class="line">  ubuntu-vg   1   1   0 wz--n-  &lt;78.50g    0</span><br></pre></td></tr></table></figure></blockquote><h2 id="resize-ext4-file-system">Resize ext4 File System</h2><p>Up to now, although LVM LV is resized, the ext4 file system is not aware of the extra available space. Simply run <code>resize2fs</code> to let it know.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ sudo resize2fs /dev/mapper/test--vg-test--lv</span><br><span class="line">resize2fs 1.46.3 (27-Jul-2021)</span><br><span class="line">Filesystem at /dev/mapper/test--vg-test--lv is mounted on /home/tonny/mnt; on-line resizing required</span><br><span class="line">old_desc_blocks = 1, new_desc_blocks = 1</span><br><span class="line">The filesystem on /dev/mapper/test--vg-test--lv is now 261120 (4k) blocks long.</span><br></pre></td></tr></table></figure><blockquote><p>We can see the available space of <code>test--vg-test--lv</code> has been enlarged.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tonny@vm:~$ df -h</span><br><span class="line">Filesystem                         Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/test--vg-test--lv      973M  1.3M  917M   1% /home/tonny/mnt</span><br></pre></td></tr></table></figure></blockquote><h2 id="references">References</h2><ul><li><a href="https://www.linuxtechi.com/extend-lvm-partitions/">https://www.linuxtechi.com/extend-lvm-partitions/</a></li><li><a href="https://www.thegeekdiary.com/centos-rhel-how-to-extend-physical-volume-in-lvm-by-extending-the-disk-partition-used/">https://www.thegeekdiary.com/centos-rhel-how-to-extend-physical-volume-in-lvm-by-extending-the-disk-partition-used/</a></li><li><a href="https://i0.wp.com/manjaro.site/wp-content/uploads/2017/08/lvm-layout.png">https://i0.wp.com/manjaro.site/wp-content/uploads/2017/08/lvm-layout.png</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;When we resize the virtual hard disk of a virtual machine or restore a disk image to a larger disk, the free space of the partition detected by Ubuntu will not increase because the partition table is unchanged. In the past, we could easily resize the ext4 root partition with the help of &lt;code&gt;resize2fs&lt;/code&gt;. However, things get complex when Ubuntu utilizes LVM partition as their default root partition.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title> Hexo </title>
    <link href="https://nekodaemon.com/2022/01/31/%E5%8D%9A%E5%AE%A2%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93%E6%97%A2-Hexo-%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%AD%94%E6%94%B9%E8%AE%B0%E5%BD%95/"/>
    <id>https://nekodaemon.com/2022/01/31/%E5%8D%9A%E5%AE%A2%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93%E6%97%A2-Hexo-%E7%AC%AC%E4%B8%89%E6%AC%A1%E9%AD%94%E6%94%B9%E8%AE%B0%E5%BD%95/</id>
    <published>2022-01-30T18:18:52.000Z</published>
    <updated>2022-01-30T18:29:15.000Z</updated>
    
    <content type="html"><![CDATA[<p> NexT  Nunjucks  Remix </p><h2 id=""></h2><figure><img data-src="/images/pasted-96.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><figure><img data-src="/images/pasted-97.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><figure><img data-src="/images/pasted-98.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><ul><li>2022.1 NexT.Remix v3 (Preview) NexT.Gemini v8 <a href="https://dnocm.com/cake/">Hexo Cake</a>  <a href="https://github.com/CaiJimmy/hugo-theme-stack">Hugo Stack</a> </li><li>2021.8 NexT.Gemini (Remix v2)</li><li>2020.5 NexT.Gemini (Remix v1) NexT.Gemini v7 Hexo Terminal  Markdown Resume </li></ul><p>NexT v8v7<del></del>NexT.Remix  NexT  Theme Inject  upstream </p><p> upstream  Hexo  utterance  giscus</p><h3 id="todo">TODO</h3><ul><li> jsdelivr  JS  CDN </li><li> giscus  integration  upstream  PR </li></ul><h2 id=""></h2><h3 id=""></h3><p>NexT  <strong></strong>  NexT  NexT </p><p>  </p><ul><li>Hexo Cake NexT v7  NexT</li><li>Hugo Stack</li></ul><p>NexT </p><h3 id=""></h3><p>NexT Remix v1  Pagination </p><p><del></del></p><h3 id=""></h3><p> <a href="https://www.whexy.com/"></a></p><ul><li></li><li><ul><li></li><li><strong></strong><strong></strong></li></ul></li></ul><p></p><p><del></del></p><p> dalao </p><p> Neko  NexT </p><h2 id=""></h2><p> Professional </p><h3 id=""></h3><p>Anyway<del></del></p><h3 id=""></h3><p></p><h3 id=""></h3><p>Azure CDN + Github Page </p><h3 id=""></h3><p></p>]]></content>
    
    
    <summary type="html">&lt;p&gt; NexT  Nunjucks  Remix &lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Unattended Ubuntu 20.04 Server Offline Installation</title>
    <link href="https://nekodaemon.com/2022/01/16/Unattended-Ubuntu-20-04-Server-Offline-Installation/"/>
    <id>https://nekodaemon.com/2022/01/16/Unattended-Ubuntu-20-04-Server-Offline-Installation/</id>
    <published>2022-01-15T16:45:11.000Z</published>
    <updated>2022-09-03T11:22:28.638Z</updated>
    
    <content type="html"><![CDATA[<p>Last year, I wrote <a href="/2021/04/27/How-to-make-an-unattended-Ubuntu-Server-Installation-ISO-with-cloud-init/">a post</a> about how to install Ubuntu 18.04 Server automatically. The major reason why I choose to install the older version is I failed to make Ubuntu 20.04 install without pressing any key at that time while the approach for the offline installation recommended by the official is not working.</p><p>There is <a href="https://www.pugetsystems.com/labs/hpc/How-To-Make-Ubuntu-Autoinstall-ISO-with-Cloud-init-2213/">an article</a> already described the detailed steps about the automatic installation of Ubuntu 20.04 Server, but according what its author said, their blog system ripped out some important characters. So, by checking with <a href="https://gist.github.com/s3rj1k/55b10cd20f31542046018fcce32f103e">this script</a>, I figured out the correct way to achieve our goal.</p><h2 id="download-the-image">Download the image</h2><p>Download the live CD image in whichever way you prefer. For the user locates in China, I would suggest you download from <a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/focal/ubuntu-20.04.3-live-server-amd64.iso">https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/focal/ubuntu-20.04.3-live-server-amd64.iso</a>.</p><h2 id="update-some-files-in-iso-image">Update some files in ISO image</h2><p>Only thing we need to do is updating several files. And here are some recommended editors.</p><ul><li>For Windows user, I strongly recommend you use <code>Ultraiso</code> to edit the ISO file.</li><li>For Linux user, <code>ISO Master</code> should work. (I didn't try it before.)</li><li>For the user who wants to deeply customize the ISO file, including unpacking <code>rootfs</code> image, <code>cubic</code> is everything you need. You can refer to <a href="(/2021/04/27/How-to-make-an-unattended-Ubuntu-Server-Installation-ISO-with-cloud-init/)">my previous post</a> and learn how it works.</li></ul><h3 id="add-kernel-arguments">Add Kernel Arguments</h3><p>Assume the root directory of ISO image is <code>/cdrom</code>. There are two bootloader configuration files need to modify, one for UEFI system, one for the legacy one. Append the kernel arguments like this,</p><ul><li><code>/cdrom/isolinux/txt.cfg</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">label live</span><br><span class="line">  menu label ^Install Ubuntu Server</span><br><span class="line">  kernel /casper/vmlinuz</span><br><span class="line">  append   initrd=/casper/initrd quiet autoinstall ds=nocloud;s=/cdrom/  ---</span><br></pre></td></tr></table></figure><ul><li><code>/cdrom/boot/grub/grub.cfg</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">menuentry <span class="string">&quot;Install Ubuntu Server&quot;</span> &#123;</span><br><span class="line"><span class="built_in">set</span> gfxpayload=keep</span><br><span class="line">linux/casper/vmlinuz   quiet autoinstall ds=nocloud\;s=/cdrom/ ---</span><br><span class="line">initrd/casper/initrd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If you would like to skip the integrity check, you could try to append the kernel argument <code>fsck.mode=skip</code> as the following example shows.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: /cdrom/isolinux/txt.cfg</span></span><br><span class="line"></span><br><span class="line">label live</span><br><span class="line">  menu label ^Install Ubuntu Server</span><br><span class="line">  kernel /casper/vmlinuz</span><br><span class="line">  append   initrd=/casper/initrd quiet fsck.mode=skip autoinstall ds=nocloud;s=/cdrom/ ---</span><br><span class="line"></span><br><span class="line"><span class="comment"># File: /cdrom/boot/grub/grub.cfg</span></span><br><span class="line"></span><br><span class="line">menuentry <span class="string">&quot;Install Ubuntu Server&quot;</span> &#123;</span><br><span class="line"><span class="built_in">set</span> gfxpayload=keep</span><br><span class="line">linux/casper/vmlinuz   quiet fsck.mode=skip autoinstall ds=nocloud\;s=/cdrom/ ---</span><br><span class="line">initrd/casper/initrd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Note: HWE Kernel is a higher version of Linux kernel compared to the default one, which is shipped with the newer drivers. Theoretically, it has a better support for the latest hardware.</p></blockquote><h3 id="add-auto-install-configurations">Add Auto-install Configurations</h3><p>Two new files are also required for automatic answering.</p><ul><li><code>/cdrom/user-data</code></li></ul><p>This configuration is what I am using now, and it is for the machine without Internet. I have verified that it can make the installation procedure fully automatic.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="attr">autoinstall:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">storage:</span>  <span class="comment"># should set the interactive default but doesn&#x27;t seem to work??</span></span><br><span class="line">    <span class="attr">layout:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">direct</span></span><br><span class="line">  <span class="attr">locale:</span> <span class="string">en_US.UTF-8</span></span><br><span class="line">  <span class="attr">keyboard:</span></span><br><span class="line">    <span class="attr">layout:</span> <span class="string">us</span></span><br><span class="line">  <span class="attr">identity:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu-server</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;$6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0&quot;</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">tonny</span></span><br><span class="line">  <span class="attr">ssh:</span></span><br><span class="line">    <span class="attr">allow-pw:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">install-server:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">package_update:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">package_upgrade:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><blockquote><p>Note:</p><ul><li><code>direct</code> storage layout means using and erasing the whole disk. (The default option provided by the interactive installer.)</li><li>The password is <code>ubuntu</code>. This can be generated by <code>mkpasswd</code>.</li></ul></blockquote><p>For more usages, check <a href="https://gist.github.com/dbkinghorn/c236aea31d76028b2b6ccdf6d3c6f07e">this example</a>.</p><ul><li><code>/cdrom/meta-data</code></li></ul><p>Just create an empty file and put it there.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Last year, I wrote &lt;a href=&quot;/2021/04/27/How-to-make-an-unattended-Ubuntu-Server-Installation-ISO-with-cloud-init/&quot;&gt;a post&lt;/a&gt; about how to install Ubuntu 18.04 Server automatically. The major reason why I choose to install the older version is I failed to make Ubuntu 20.04 install without pressing any key at that time while the approach for the offline installation recommended by the official is not working.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>SC21 - </title>
    <link href="https://nekodaemon.com/2022/01/01/SC21%E5%9B%9E%E9%A1%BE-%E8%B5%A2%E4%BA%86%EF%BC%8C%E4%BD%86%E5%8F%AA%E8%B5%A2%E4%BA%86%E4%B8%80%E7%82%B9%E7%82%B9/"/>
    <id>https://nekodaemon.com/2022/01/01/SC21%E5%9B%9E%E9%A1%BE-%E8%B5%A2%E4%BA%86%EF%BC%8C%E4%BD%86%E5%8F%AA%E8%B5%A2%E4%BA%86%E4%B8%80%E7%82%B9%E7%82%B9/</id>
    <published>2021-12-31T19:55:10.000Z</published>
    <updated>2021-12-31T19:56:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>SC21<del></del></p><h2 id="sc20">SC20</h2><p>SC20SC21SC20SC20SCC</p><ul><li>Cyclecloud<code>cluster-init</code>1</li><li>16placeholder</li></ul><p>GDRGPU P2P2Webinar46reportpaperpaperExcel</p><p>MemXCTCPUGPUGPUHPCX OpenMPINVIDIA HPC SDKOpenMPIHPCXNVIDIAHPC SDKNVIDIAOpenMPIMPIMPIMCAGDBGDBTracebackGDR P2PHPCXOpenMPICUDA AwareGDRHPCXNVIDIA HPC SDKMPI4throttleApplication</p><p>CPU<del></del><code>mpirun</code><code>ppn</code><code>map-by</code>Job SchedulerSlurmSlurm<code>mpirun</code>HybridMPI + OpenMPMPI RankCPU1Rank</p><p>               Academicreport</p><p>ApplicationsCESMGROMACSMiniViteBenchmarksFunding All inBenchmarksHPL120TFlops<strong></strong>ETH129TTHU300TTHPCGIO5003.895.765am</p><p>HPLHPCGTplanAzureGPUGPUV100GPU<del></del>HPLIO500MadFS<a href="https://www.youtube.com/watch?v=NRZhFoBC_Ak&amp;t=8s">IO500 S: There is rjgg behind MadFS - YouTube</a>THUSystemtqlTUNA</p><p>SC21SC20</p><h2 id="sc21-phase-0">SC21 Phase 0</h2><p>20aka</p><blockquote><p>Neko.d&gt; ...</p></blockquote><p></p><p>FemaleTransgenderDiversityproposal</p><p>proposaloffloadEnglish paragraphsmergeproposaloffloadpaperpaperproposalddl</p><blockquote><p>Neko.d&gt; I AM REALLY ANGRY!</p></blockquote><p>angryproposalreviewer</p><p>proposalTISCDiversityDiversityreviewerreviewer<del></del></p><h2 id="sc21-phase-1">SC21 Phase 1</h2><p><del></del></p><blockquote><p>&gt; Azure</p><p>1&gt; </p><p>2&gt; </p></blockquote><p>Oracle</p><p>Linux<code>passwd</code><code>sudoer.d</code><code>sudoer.d</code><code>sudo</code><code>sudoer.d</code><code>sudo</code><code>sudo</code>OracleTechnical LeaderMarcinserial consolegrub<code>bootargs init=/bin/bash</code>grubWindows Terminalserial consolegrubTUIroot</p><blockquote><p>Marcin&gt; :) Sysadmin Sunday</p><p>Neko.d&gt; Oh. Sorry to disturb your beautiful Sunday morning lol.</p></blockquote><p>Marcin</p><ul><li></li><li>LDAP</li><li><code>playbook</code></li><li><code>ssh-agent</code></li><li>...</li></ul><p>Azure</p><ul><li><code>cloud-init</code>workaround<code>cloud-init</code>init</li><li>image<ul><li>VMImage<code>OpenLogic:CentOS-HPC:7_9-gen2:latest</code><ul><li>PowerShell</li></ul></li><li>CentOS 7.98.1<ul><li>GPUGPUNVSwitchFabric ManagerNVSwitch<code>cudaErrorSystemNotReady</code><ul><li>NFS</li></ul></li><li>IBOFED</li></ul></li></ul></li><li>SlurmVMallocateVMVM</li></ul><p>AzureAndyAndySCCKathleen complain</p><blockquote><p>Kathleen&gt; AndyWebinar</p><p>Kathleen&gt; Stand up meeting</p></blockquote><p>AndyCycleCloud Console<code>cloud-init</code><code>cloud-init</code></p><p>AzureGPUA10027CPUCentOS 8NVSwitchVM7.9Lmodmodule load intelGCCC++ ABI</p><p></p><ul><li>SpacktmpTMPDIR</li><li>Spackcleanbootstrap<code>spack clean -b</code><ul><li>NVIDIA HPC SDKAny changes to your gcc compilers requires you to reinstall the HPC SDK</li></ul></li><li><code>nfslock</code>No locks available</li></ul><p>Spacke.g., OpenBLASFFTWGPUGCCICCICXNVCAMDAOCCAOCLICC+MKLMKLOpenBLASNVCCHost<code>--ccbin</code></p><h2 id="sc21-phase-2">SC21 Phase 2</h2><p>Azure<del></del>CardioidOracleQEAzure9.30ammeetinginstructionsinstructionsmeetingbreakout room</p><p>instructions</p><ul><li>Submissioninstruction</li><li>instructionGitHubprivate</li></ul><p>instructionsremoteSC<del></del>Anyway</p><h3 id="cardioid">Cardioid</h3><p>assign20bugNVRTCLLVM+PTXbug</p><ul><li>GPUOracleGPUCardioidvariants</li><li>CardioidSpacksucksSpackSpack</li><li>OracleOracle Linux 7based on REHL 7<del>CentOS 7</del>C++ ABI</li></ul><p>gdb BacktraceNaNinstructionNaNNaNNaNbacktraceulimitfor<code>0x7ff</code>base+sizeespdebug1amday2debug</p><p>50%12am-8am<del></del>Chair complain</p><blockquote><p>Kathleen&gt; </p></blockquote><p>argueChairWarp up meetingsocial<del></del></p><p>degdbprintfinteger overflowoverflowunderflowoverflowtrickyworkaroundMPIoverflowoverflowMPIGDBRDMAoverflowpropagateMPI</p><h3 id=""></h3><p>AI paperpaperAzureOracle......</p><p>OraclebugOracleAzureMVAPICHSpackIB100GRoCEAzureIB......MPI100%MPIMPIgdb</p><p>MVAPICHSlurmMPI<strong></strong>MVAPICHfabricHPCX MPIDay2OracleMarcin<a href="https://blogs.oracle.com/cloud-infrastructure/post/running-applications-on-oracle-cloud-using-cluster-networking">MPI</a> OpenMPIIntel MPIPlatform MPIMVAPICHMVAPICH</p><blockquote><p>Fun FactMarcinMVAPICH</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun -hosts hpc-node-1,hpc-node-2 -env MV2_IBA_HCA=mlx5_2 -env MV2_USE_RoCE=1 /nfs/cluster/osu-micro-benchmarks-5.8/mpi/one-sided/osu_get_latency</span><br></pre></td></tr></table></figure><p><code>MV2_IBA_HCA</code><code>MV2_IBA_HCA</code></p><p></p><blockquote><p>Neko.d&gt; MPIMVAPICHbug</p><p>Marcin&gt; we can take a look and report to Dr. DK Panda.</p></blockquote><p>bossbug reportauthor</p></blockquote><p>debugMVAPICHinstructionOpenMPIIntel MPIIntel MPItrendIntel MPI + GCC 9ramBLeMPIIntel MPIbuff</p><blockquote><p>buff</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-iface ens800f0 -genv UCX_TLS rc,self,sm -genv UCX_NET_DEVICES mlx5_2:1 -genv I_MPI_FABRICS shm:ofi -genv I_MPI_FALLBACK 0</span><br></pre></td></tr></table></figure></blockquote><p>MVAPICHprojectco-located programsMVAPICHMVAPICHinstructionIntel MPIMVAPICHIntel MPItrend</p><h3 id="qe-">QE &amp; </h3><p><del>AWSInternAWS</del>QECPUV100Intel HaswellIntelCPUHaswellAVX2AMD</p><p>QECPUCPUCPUGPUDay 1Day 2benchmarksGPUGPU</p><p>Day 1<strong></strong>MPIHPCXMPIPythonNVCCMPIDay 2A100</p><blockquote><p>Neko.d&gt;  <span class="citation" data-cites="12:25">@12:25</span></p><p>&gt;  <span class="citation" data-cites="14:48">@14:48</span></p></blockquote><p><strong>GPU</strong>debugGPUdebugbenchmarkA100QEGPU</p><blockquote><p>task</p></blockquote><h2 id="sc21-phase-3">SC21 Phase 3</h2><p>benchmarksDay 2</p><blockquote><p>&gt; </p></blockquote><p><del></del></p><p>IO500CycleCloudBeeGFS8T10%IO50010FS810</p><p>IO500......10Day 2</p><p>QE1kbenchmarksA100V100...V100TV100benchmarkV100AzureImageIBIBImageV100akaV100V100OFEDT</p><p>clustersshbroadcast inputterminal10+OFEDOFEDLinuxGPUOFEDCUDAV100</p><p>V100ShanghaiTechA100IBIBA100V100A100</p><blockquote><p>Neko.d&gt; </p></blockquote><p>A1008A100A100A100A100Azure0101020</p><blockquote><p>MacChromeCycleCloud Web ConsoleHTTPScurl</p></blockquote><p>6A100A100</p><p><strong>HPLHPCG</strong><strong></strong>ASCLinux6HPL100ThtopCPUMPI/Context SwitchVerification failed</p><p>HPLAzure</p><p>48A100THPLHPLHPCGIO500SC20T</p><p>SA100HPL300T284Toverride280TSC20ddlupdateemmmGrafanaHPLSC21LINPACK0 GFLOPS</p><p>IO500108LustreIO500*</p><h2 id="sc21-phase-3.5interview">SC21 Phase 3.5Interview</h2><p>Poster+interviewPoster<strong>Poster</strong>iPad<del></del>Poster</p><blockquote><p>Neko.d&gt; </p></blockquote><p>Poster</p><p>InterviewCardioid100+interviewerinterview</p><ul><li>Cardioid</li><li>interviewer</li></ul><p></p><ul><li></li><li></li><li><ul><li>tmsimulation</li></ul></li></ul><h2 id="ending">Ending</h2><p>1w10/SC2x 2x 2x 1xYear 0 PhD StudentASC22<del>offer</del>PresenterSCnikesuccessorSC SCC</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;SC21&lt;del&gt;&lt;/del&gt;&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Everything you need to know about Splitting NCCL Communicators</title>
    <link href="https://nekodaemon.com/2021/12/15/Everything-you-need-to-know-about-Splitting-NCCL-Communicators/"/>
    <id>https://nekodaemon.com/2021/12/15/Everything-you-need-to-know-about-Splitting-NCCL-Communicators/</id>
    <published>2021-12-14T18:47:00.000Z</published>
    <updated>2021-12-17T10:57:24.000Z</updated>
    
    <content type="html"><![CDATA[<p>MPI allows to create a new communicator by splitting an existing one into a sub-communicator, which can make our program dynamically select a subset of computing nodes to involve in the collective communication operations, such as all-reduce and all-gather operations. NCCL also has a similar feature, but it is not well-documented yet.</p><h2 id="tldr">TL;DR</h2><p>Since NCCL relies on MPI to run on multiple nodes, the following example code is based on MPI Programming Model. Assume there are 4 CUDA GPUs and 4 corresponding MPI ranks. This code performs all-reduce operation within the first two and the last two ranks simultaneously.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;nccl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mpi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thrust/device_ptr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thrust/fill.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">MPI_Init</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">int</span> world_size, world_rank;</span><br><span class="line">  <span class="built_in">MPI_Comm_size</span>(MPI_COMM_WORLD, &amp;world_size);</span><br><span class="line">  <span class="built_in">MPI_Comm_rank</span>(MPI_COMM_WORLD, &amp;world_rank);</span><br><span class="line">  <span class="built_in">assert</span>(world_size == <span class="number">4</span>);</span><br><span class="line">  <span class="built_in">cudaSetDevice</span>(world_rank); <span class="comment">// GPU N binds to MPI rank N</span></span><br><span class="line"></span><br><span class="line">  ncclUniqueId nccl_id, nccl_ids[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">size_t</span> id_size = <span class="built_in"><span class="keyword">sizeof</span></span>(ncclUniqueId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Generate Unique ID */</span></span><br><span class="line">  <span class="comment">// nccl_id is a simple struct with the size of exact 128 bytes</span></span><br><span class="line">  <span class="comment">// so it can be transferred over MPI</span></span><br><span class="line">  <span class="built_in">ncclGetUniqueId</span>(&amp;nccl_id);</span><br><span class="line">  <span class="built_in">MPI_Allgather</span>(&amp;nccl_id, id_size, MPI_UINT8_T,</span><br><span class="line">                &amp;nccl_ids[<span class="number">0</span>], id_size, MPI_UINT8_T, MPI_COMM_WORLD);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Create a sub-communicator */</span></span><br><span class="line">  ncclComm_t nccl_comm;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (world_rank &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">ncclCommInitRank</span>(&amp;nccl_comm, <span class="number">2</span>, nccl_ids[<span class="number">0</span>], world_rank);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (world_rank &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">ncclCommInitRank</span>(&amp;nccl_comm, <span class="number">2</span>, nccl_ids[<span class="number">2</span>], world_rank - <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Test */</span></span><br><span class="line">  <span class="keyword">constexpr</span> <span class="keyword">size_t</span> N = (<span class="keyword">size_t</span>)<span class="number">1e3</span>;</span><br><span class="line">  <span class="keyword">constexpr</span> <span class="keyword">size_t</span> arr_size = <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int64_t</span>) * N;</span><br><span class="line">  <span class="keyword">void</span> *arr, *arr_host;</span><br><span class="line">  <span class="built_in">cudaMalloc</span>(&amp;arr, arr_size);</span><br><span class="line">  <span class="built_in">cudaMallocHost</span>(&amp;arr_host, arr_size);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* Init the array on local GPU */</span></span><br><span class="line">  <span class="function">thrust::device_ptr&lt;<span class="keyword">int64_t</span>&gt; <span class="title">arr_ptr</span><span class="params">((<span class="keyword">int64_t</span>*)arr)</span></span>;</span><br><span class="line">  thrust::<span class="built_in">fill</span>(arr_ptr, arr_ptr + N, world_rank);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">ncclAllReduce</span>(arr, arr, N, ncclInt64, ncclSum, nccl_comm, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">cudaMemcpy</span>(arr_host, arr, arr_size, cudaMemcpyDeviceToHost);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[rank%d] result: %ld\n&quot;</span>, world_rank, ((<span class="keyword">int64_t</span>*)arr_host)[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">MPI_Finalize</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>This code can be compiled and run on my machine with these commands,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvcc -ccbin mpic++ test.cu -o <span class="built_in">test</span> -L/usr/<span class="built_in">local</span>/cuda/lib -lnccl</span><br><span class="line">mpirun -n 4 ./<span class="built_in">test</span></span><br></pre></td></tr></table></figure><blockquote><p>Note: Using <code>nvcc</code> to compile MPI code is not a common practice. It is recommended to compile it with <code>mpic++</code> from a CUDA-Aware MPI variant.</p></blockquote><p>The output of this program should be,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[rank0] result: 1 <span class="comment"># 0 + 1 = 1</span></span><br><span class="line">[rank1] result: 1</span><br><span class="line">[rank2] result: 5 <span class="comment"># 2 + 3 = 5</span></span><br><span class="line">[rank3] result: 5</span><br></pre></td></tr></table></figure><p><strong>The key is <code>ncclCommInitRank</code>. Suppose only a subset of ranks initializes the communicator with the same unique ID belonging to one of them. In that case, this communicator will ignore other ranks that are not in this subset.</strong></p><h2 id="usage-of-ncclcomminitrank">Usage of ncclCommInitRank</h2><blockquote><p>Official API explanation:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ncclResult_t <span class="title">ncclCommInitRank</span><span class="params">(ncclComm_t *comm, <span class="keyword">int</span> nranks, ncclUniqueId commId, <span class="keyword">int</span> rank)</span></span></span><br></pre></td></tr></table></figure><p>Creates a new communicator (multi thread/process version). rank must be between <code>0</code> and <code>nranks-1</code> and unique within a communicator clique. Each rank is associated to a CUDA device, which has to be set before calling <code>ncclCommInitRank</code>. <code>ncclCommInitRank</code> implicitly synchronizes with other ranks, so it must be called by different threads/processes or use <code>ncclGroupStart</code>/<code>ncclGroupEnd</code>.</p></blockquote><p>In addition to the official instructions, we should also know,</p><ul><li>Each unique ID should only be used once.</li><li><code>ncclGetUniqueId</code> can be invoked multiple times, and it will return a different unique ID each time. Meanwhile, the unique ID generated before is still working.</li><li>It is safe to communicate within disjoint subsets of nodes simultaneously.</li><li>Using NCCL to perform inter-GPU communication concurrently with CUDA-aware MPI may create deadlocks.</li></ul><h2 id="performance">Performance</h2><p>Moreover, I also evaluate the influence on performance bring by sub-grouping.</p><p>The testbed is,</p><ul><li>AWS <code>g4dn.metal</code> instance with 8x NVIDIA Tesla T4 GPUs.</li><li>Shipped with AWS Deep Learning AMI<ul><li>OS: Ubuntu 18.04 (Kernel Version: Linux 5.4)</li><li>CUDA Toolkit: 11.0 (Driver Version: 450.119.03 )</li></ul></li></ul><p>First of all, I would like to emphasize the GPU topology of this bare-metal machine.</p><blockquote><p>Note: We should extract the topology information from physical machines instead of virtual machines since the hypervisor may fuzz the result due to security reasons.</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nvidia-smi topo -m</span></span><br><span class="line">        GPU0    GPU1    GPU2    GPU3    GPU4    GPU5    GPU6    GPU7    CPU Affinity    NUMA Affinity</span><br><span class="line">GPU0     X      PHB     NODE    NODE    SYS     SYS     SYS     SYS     0-23,48-71      0</span><br><span class="line">GPU1    PHB      X      NODE    NODE    SYS     SYS     SYS     SYS     0-23,48-71      0</span><br><span class="line">GPU2    NODE    NODE     X      PHB     SYS     SYS     SYS     SYS     0-23,48-71      0</span><br><span class="line">GPU3    NODE    NODE    PHB      X      SYS     SYS     SYS     SYS     0-23,48-71      0</span><br><span class="line">GPU4    SYS     SYS     SYS     SYS      X      PHB     NODE    NODE    24-47,72-95     1</span><br><span class="line">GPU5    SYS     SYS     SYS     SYS     PHB      X      NODE    NODE    24-47,72-95     1</span><br><span class="line">GPU6    SYS     SYS     SYS     SYS     NODE    NODE     X      PHB     24-47,72-95     1</span><br><span class="line">GPU7    SYS     SYS     SYS     SYS     NODE    NODE    PHB      X      24-47,72-95     1</span><br></pre></td></tr></table></figure><p>It looks like a balanced tree topology. We could expect two neighbor GPUs will have higher communication efficiency.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">UPI                   </span><br><span class="line"> |--CPU0              </span><br><span class="line"> |   |--PCIe Switch   </span><br><span class="line"> |   |   |--GPU0      </span><br><span class="line"> |   |   |--GPU1      </span><br><span class="line"> |   |--PCIe Switch   </span><br><span class="line"> |       |--GPU2      </span><br><span class="line"> |       |--GPU3      </span><br><span class="line"> |--CPU1              </span><br><span class="line">     |--PCIe Switch   </span><br><span class="line">     |   |--GPU4      </span><br><span class="line">     |   |--GPU5      </span><br><span class="line">     |--PCIe Switch   </span><br><span class="line">         |--GPU6      </span><br><span class="line">         |--GPU7      </span><br></pre></td></tr></table></figure><p>The result below is measured on the root rank, and each experiment is repeated 5 times. Meanwhile, the environment <code>CUDA_VISIBLE_DEVICES</code> was set to reorder GPUs binded to MPI ranks. CPU binding remains unset.</p><p>And the meaning of the notations on communicators is,</p><ul><li><code>0/1</code>: Only one communicator performing all-reduce on physical GPU 0/1.</li><li><code>0/1 + 2/3</code>: Two communicators are working at the same time, and each of them perform all-reduce on two GPUs independently.</li><li><code>0-7</code>: Equivalent to <code>0/1/2/.../6/7</code>.</li></ul><figure><img data-src="/images/pasted-95.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><p>From the result above, we can conclude that,</p><ul><li>GPUs are working at PCIe Gen3 x8 mode as the PCIe Switch splits one PCIe x16 slot into two x8 slots.<ul><li>Double checked by <code>nvidia-smi --query-gpu=pcie.link.gen.current --format=csv</code> and <code>sudo lspci -vvv</code></li></ul></li><li>The GPU Topology will significantly affect the performance of all-reduce.<ul><li>The topology that NVIDIA DGX adopt should obviously accelerate collective communication operations.</li></ul></li><li>The interference between two concurrent communicators is not quite noticeable.</li><li>UPI bus is not a bottleneck when two PCIe Gen3 x16 devices (PCIe Switches) transmit a large data chunk over UPI bus.</li></ul><h2 id="reference">Reference</h2><ul><li><a href="https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/mpi.html#inter-gpu-communication-with-cuda-aware-mpi">NCCL and MPI  NCCL 2.11.4 documentation (nvidia.com)</a></li><li><a href="https://developer.nvidia.com/blog/fast-multi-gpu-collectives-nccl/">Fast Multi-GPU collectives with NCCL</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;MPI allows to create a new communicator by splitting an existing one into a sub-communicator, which can make our program dynamically select a subset of computing nodes to involve in the collective communication operations, such as all-reduce and all-gather operations. NCCL also has a similar feature, but it is not well-documented yet.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Docker</title>
    <link href="https://nekodaemon.com/2021/09/06/%E6%8A%8ADocker%E5%AE%B9%E5%99%A8%E5%BD%93%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%94%A8/"/>
    <id>https://nekodaemon.com/2021/09/06/%E6%8A%8ADocker%E5%AE%B9%E5%99%A8%E5%BD%93%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%94%A8/</id>
    <published>2021-09-06T07:01:43.000Z</published>
    <updated>2021-10-14T16:04:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>Docker</p><h2 id=""></h2><h3 id="best-practice">Best Practice</h3><p>Docker ImageDockerfileDocker ContainerDocker Image</p><h3 id=""></h3><p>DockerDockerDocker<code>docker</code></p><p>DockerRootless</p><h2 id=""></h2><h3 id=""></h3><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      |---------push--&gt; (Docker Hub)</span><br><span class="line">      |---------save--&gt; (tar File)</span><br><span class="line">      |</span><br><span class="line">Docker Image----run---&gt; Docker Container    </span><br><span class="line">                             |</span><br><span class="line">      |---------commit--------|</span><br><span class="line">      |---------pull----(Docker Hub)</span><br><span class="line">      |---------load----(tar File)</span><br><span class="line">      |---------build---(Dockerfile)</span><br></pre></td></tr></table></figure><h3 id=""></h3><p><code>:Tag</code><code>Ubuntu:18.04</code><code>Ubuntu</code>Tag<code>18.04</code></p><h3 id=""></h3><ul><li><code>docker ps</code> <ul><li><code>docker ps -a</code> </li></ul></li><li><code>docker rm -f</code> </li><li><code>docker images</code> </li><li><code>docker pull</code> </li><li><code>docker rmi</code> </li></ul><h3 id="dockerhub">DockerHub</h3><p></p><h2 id=""></h2><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name your_ct_name --privileged --network host --restart always ubuntu:18.04 bash</span><br></pre></td></tr></table></figure><blockquote><p></p><ul><li><code>-d</code> + <code>-i</code> + <code>bash</code> <code>bash</code></li><li><code>--restart always</code> </li><li><code>ubuntu:18.04</code> Ubuntu 18.04</li><li><code>--privileged</code> </li><li><code>--network host</code> </li></ul></blockquote><p>CUDA</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --name your_ct_name --privileged --network host --restart always --gpus all nvidia/cuda:11.0.3-devel-ubuntu18.04 bash</span><br></pre></td></tr></table></figure><blockquote><p></p><ul><li><code>nvidia/cuda:11.0.3-devel-ubuntu18.04</code> CUDA 11.0.3Ubuntu 18.04<ul><li>CUDA<code>nvidia-smi</code> CUDA</li><li><code>devel</code><code>nvcc</code><code>runtime</code></li></ul></li><li><code>--gpus all</code> GPU</li></ul></blockquote><p><a href="https://hub.docker.com/r/nvidia/cuda/tags?page=1&amp;ordering=last_updated">https://hub.docker.com/r/nvidia/cuda/tags?page=1&amp;ordering=last_updated</a></p><h2 id="bash">bash</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it your_ct_name bash</span><br></pre></td></tr></table></figure><blockquote><p></p><ul><li><code>-i</code> + <code>-t</code> </li></ul></blockquote><blockquote><p>apt</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s#archive.ubuntu.com#mirrors.sustech.edu.cn#g&quot;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure></blockquote><h2 id=""></h2><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit your_ct_name your_images_name:your_tag</span><br></pre></td></tr></table></figure><p></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save your_images_name:your_tag -o your_file.tar</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i your_file.tar</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Docker&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>CDN</title>
    <link href="https://nekodaemon.com/2021/08/12/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2CDN%E9%80%89%E5%9E%8B%E5%92%8C%E8%BF%9B%E9%98%B6%E7%8E%A9%E6%B3%95%E6%8C%87%E5%8C%97/"/>
    <id>https://nekodaemon.com/2021/08/12/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2CDN%E9%80%89%E5%9E%8B%E5%92%8C%E8%BF%9B%E9%98%B6%E7%8E%A9%E6%B3%95%E6%8C%87%E5%8C%97/</id>
    <published>2021-08-11T18:49:03.000Z</published>
    <updated>2021-08-11T18:50:44.000Z</updated>
    
    <content type="html"><![CDATA[<p>CDNCDNCDNCDNCDN</p><h2 id="tldr">TL;DR</h2><p>CDN24</p><ul><li></li><li></li><li>CDN</li><li></li></ul><p>Azure CDN (Microsoft Standard) + GitHub Pages</p><p>+CDN</p><h2 id="cdn">CDN</h2><p>CDNCacheCache MissCDNCDN24</p><p>CDN</p><ul><li>CDNCache</li><li>CDN</li></ul><p>CDN</p><h2 id=""></h2><p></p><h3 id=""></h3><p>HexoVPS</p><ul><li>SLAVPSSLA99.9%</li><li><ul><li>Azure Blob Storage0.1-0.2</li><li>AWS S3 BucketcoverAzure</li></ul></li></ul><p></p><ul><li>IAM</li><li>CDNHTTPS</li><li><ul><li>Azure<span class="math inline">\(web\)</span>Linux</li><li>AWSS3 BucketGeoDNS</li><li>...</li></ul></li></ul><p></p><h3 id=""></h3><p>CDNCache Miss</p><ul><li>140</li><li></li></ul><p>CN2 GIA</p><p></p><ul><li></li><li></li><li>PageSpeedSEO</li></ul><p></p><h3 id=""></h3><p>CDNCDN</p><ul><li>CDN<ul><li>Azure Front Door</li><li>Azure CDN (Standard Microsoft)Rule Engine</li></ul></li><li>GeoDNSDNSCDNDNS<ul><li>Azure Traffic Manager430</li><li>AWS Route 53Policy Record</li><li>DNSPod360rmb</li><li>198rmb</li></ul></li></ul><h3 id=""></h3><p>GeoDNSGitHub PagesFastly CDNGitHub Pagesgeo-replicationDNSCDNHexoGitHub Pages</p><h2 id="cdn">CDN</h2><h3 id=""></h3><p><strong></strong>CDN</p><ul><li>T0<ul><li>Azure CDN</li></ul></li><li>T1CN2VPS<ul><li>AWS CloudFront</li><li>UDomain</li><li>CloudCone</li><li></li></ul></li><li>T1.5VPS<ul><li>Cloudflare</li></ul></li></ul><p></p><h3 id=""></h3><ul><li>T0<ul><li>Azure Front DoorAzure CDN (Standard Microsoft)Rule170</li></ul></li><li>T0.9<ul><li>AWS Lightsail DistributionCloudFront550GB</li></ul></li><li>T1<ul><li>Azure CDN (Standard)11GB5RulesAzure</li><li>CloudFront0.121GB</li><li>UDomain1.21GB</li><li>CloudCone0.0451GB20</li></ul></li><li>T2<ul><li>Cloudflare0</li></ul></li></ul><h3 id=""></h3><p>Azure CDN (Standard Microsoft)Front DoorCDNCloudFlareVPSAzureCNAMEDNS<code>cdnverify</code>TLSAWSCDNHTTPSHTTPFront DoorCDN5HTTPSHSTSCDN</p><h2 id="summary">Summary</h2><p>Azure CDN (Microsoft Standard) + GitHub Pages5rmbPageSpeed+AWS CDNPageSpeed320CloudflarePageSpeedChrome Lightroom</p><p></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;CDNCDNCDNCDNCDN&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Design of TensorFlow XLA Sharding System</title>
    <link href="https://nekodaemon.com/2021/08/04/Design-of-TensorFlow-XLA-Sharding-System/"/>
    <id>https://nekodaemon.com/2021/08/04/Design-of-TensorFlow-XLA-Sharding-System/</id>
    <published>2021-08-04T13:47:59.000Z</published>
    <updated>2021-08-05T01:38:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>Recently, a SOTA sharding approach, GSPMD/GShard, was proposed and it provides an intuitive interface to partition a large array on arbitrary dimensions, while utilizing sharding propagation algorithms to automatically infer the partitioning strategy for tensors without user-specified sharding specifications. This document introduces the design and the implementation of XLA Sharding System.</p><figure><img data-src="/images/pasted-92.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><h2 id="hlosharding-object"><code>HloSharding</code> Object</h2><p>First of all, <strong>we need a way to represent sharding specifications</strong> using programming language. XLA designed an object to do such a thing, and this object contains numerous variables and a set of supporting functions to configure itself. Some attributes of <code>HloSharding</code> are listed below.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// File: tensorflow/compiler/xla/service/hlo_sharding.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HloSharding</span> &#123;</span></span><br><span class="line">  <span class="keyword">bool</span> replicated_;</span><br><span class="line">  <span class="keyword">bool</span> maximal_;</span><br><span class="line">  <span class="keyword">bool</span> tuple_;</span><br><span class="line">  <span class="keyword">bool</span> manual_;</span><br><span class="line">  <span class="comment">// This field is only used if replicated_ is false. If maximal_ is true, then</span></span><br><span class="line">  <span class="comment">// the field contains a rank 1 array with a single element, which is the</span></span><br><span class="line">  <span class="comment">// device the HLO is assigned to. If maximal_ is false, the field contains an</span></span><br><span class="line">  <span class="comment">// array with the same rank as the corresponding HLO. The dimension sizes of</span></span><br><span class="line">  <span class="comment">// the array describe the number of ways the HLO is partitioned along each</span></span><br><span class="line">  <span class="comment">// dimension. The values of the array specify which device each tile of</span></span><br><span class="line">  <span class="comment">// the HLO is assigned to. The index of each value determines which tile it</span></span><br><span class="line">  <span class="comment">// takes.</span></span><br><span class="line">  <span class="comment">// For example, &#123;&#123;&#123;2, 3&#125;&#125;, &#123;&#123;5, 7&#125;&#125;&#125; (whose ToString representation is</span></span><br><span class="line">  <span class="comment">// &quot;&#123;devices=[2,1,2]2,3,5,7&#125;&quot;), means that dimension 1 is split two way and</span></span><br><span class="line">  <span class="comment">// dimension 3 is split 2 way. Core 5, whose index is [2,1,1] will take the</span></span><br><span class="line">  <span class="comment">// tile that contains the 2nd half of dimension 1 and the 1st half of</span></span><br><span class="line">  <span class="comment">// dimension 3.</span></span><br><span class="line">  Array&lt;int64&gt; tile_assignment_;</span><br><span class="line">  <span class="comment">// Only non-empty when tuple_ is true. If a tuple is empty then one entry is</span></span><br><span class="line">  <span class="comment">// present for the root. This is a flattened list of all the leaf shardings in</span></span><br><span class="line">  <span class="comment">// a tuple shape, by pre-order walk (ShapeTree iterator order).</span></span><br><span class="line">  std::vector&lt;HloSharding&gt; tuple_elements_;</span><br><span class="line">  <span class="comment">// This flag is to support partial replication and partial sharding. If it is</span></span><br><span class="line">  <span class="comment">// true, tile_assignment_ will have an extra dimension in addition to the data</span></span><br><span class="line">  <span class="comment">// shape rank, and the added last dimension represents the subgroups of</span></span><br><span class="line">  <span class="comment">// replications, i.e., elements in slice [..., :] will be replicated.</span></span><br><span class="line">  <span class="keyword">bool</span> replicate_on_last_tile_dim_;</span><br><span class="line">  <span class="comment">// This field is used to track the source of this sharding, usually derived</span></span><br><span class="line">  <span class="comment">// from instructions. Multiple metadata may be populated if sharding is</span></span><br><span class="line">  <span class="comment">// combined with other shardings. Metadata are to not be populated when</span></span><br><span class="line">  <span class="comment">// tuple_ == true and instead metadata should be set on individual tuple</span></span><br><span class="line">  <span class="comment">// elements.</span></span><br><span class="line">  std::vector&lt;OpMetadata&gt; metadata_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Array&lt;int64&gt; tile_assignment_</code> here is multi-dimensional with arbitrary shape. <code>&#123;devices=[2,1,2]2,3,5,7&#125;</code> means the shape of <code>tile_assignment_</code> is <code>[2,1,2]</code>, while the values are <code>&#123;2,3,5,7&#125;</code>.</p><p><code>std::vector&lt;HloSharding&gt; tuple_elements_</code> probably was designed to specify the sharding specifications of outputs.</p><p><em>I am not aware of what the roles of <code>maximal_</code>, <code>tuple_elements_</code> are. Is there any body know that?</em></p><p>Note that each single object could be shared by multiple instructions. By doing this, the cost of creating and maintaining several instances with the exact same contents could be eliminated.</p><h2 id="extended-hlo-ir-attribute">Extended HLO IR Attribute</h2><p>The original implementation of XLA added the attribute <code>std::shared_ptr&lt;const HloSharding&gt; sharding_</code> to the class <code>xla::HloInstruction</code>, which is declared in <code>tensorflow/compiler/xla/service/hlo_instruction.h</code>. A common usage of this HLO Instruction Attribute is to <strong>declare sharded tensors</strong>. Here is a sample HLO IR code with sharding attributes. Note that the Propagation Algorithm may fill in this attribute for those instructions without it.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">primitive_computation_add.<span class="number">6</span> &#123;</span><br><span class="line">  parameter.<span class="number">7</span> = <span class="built_in">f32</span>[] parameter(<span class="number">0</span>)</span><br><span class="line">  parameter.<span class="number">8</span> = <span class="built_in">f32</span>[] parameter(<span class="number">1</span>)</span><br><span class="line">  ROOT add.<span class="number">9</span> = <span class="built_in">f32</span>[] add(parameter.<span class="number">7</span>, parameter.<span class="number">8</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ENTRY xmap__lambda_.<span class="number">12</span> &#123;</span><br><span class="line">  constant.<span class="number">2</span> = pred[] constant(<span class="literal">false</span>)</span><br><span class="line">  parameter.<span class="number">1</span> = <span class="built_in">f32</span>[<span class="number">8</span>]&#123;<span class="number">0</span>&#125; parameter(<span class="number">0</span>), parameter_replication=&#123;<span class="literal">false</span>&#125;, sharding=&#123;replicated&#125;</span><br><span class="line">  custom-call.<span class="number">3</span> = <span class="built_in">f32</span>[<span class="number">8</span>]&#123;<span class="number">0</span>&#125; custom-call(parameter.<span class="number">1</span>), custom_call_target=<span class="string">&quot;Sharding&quot;</span>, sharding=&#123;devices=[<span class="number">4</span>]<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">  sine.<span class="number">4</span> = <span class="built_in">f32</span>[<span class="number">8</span>]&#123;<span class="number">0</span>&#125; sine(custom-call.<span class="number">3</span>)</span><br><span class="line">  constant.<span class="number">5</span> = <span class="built_in">f32</span>[] constant(<span class="number">0</span>)</span><br><span class="line">  reduce.<span class="number">10</span> = <span class="built_in">f32</span>[] reduce(sine.<span class="number">4</span>, constant.<span class="number">5</span>), dimensions=&#123;<span class="number">0</span>&#125;, to_apply=primitive_computation_add.<span class="number">6</span></span><br><span class="line">  ROOT tuple.<span class="number">11</span> = (<span class="built_in">f32</span>[]) tuple(reduce.<span class="number">10</span>), sharding=&#123;&#123;replicated&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Note: this HLO IR code is compiled from this JAX Frontend code</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@jtu.with_mesh(<span class="params">[(<span class="params"><span class="string">&#x27;x&#x27;</span>, <span class="number">4</span></span>)]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    f = pjit(<span class="keyword">lambda</span> x: jnp.sin(x).<span class="built_in">sum</span>(),</span><br><span class="line">             in_axis_resources=(P(<span class="string">&#x27;x&#x27;</span>),),</span><br><span class="line">             out_axis_resources=<span class="literal">None</span>)</span><br><span class="line">    x = jnp.arange(<span class="number">8</span>, dtype=jnp.float32)</span><br><span class="line">    f(x)</span><br></pre></td></tr></table></figure><p>This example illustrates a lambda function takes a replicated tensor as the input, and splits this tensor by invoking <code>custom-call</code>, then performs the calculation.</p><h2 id="spmd-partitioner">SPMD Partitioner</h2><p>You might notice that in the previous example, the instructions invoking operators (e.g. reduce.10) dont contain sharding attributes. That leads to a critical question, <strong>how a regular operator reacts to sharded tensors</strong>. The solution of XLA is introducing SPMD Partitioner, which is mainly responsible for converting a full-sized operator into a partition-sized operator by adding necessary collective communication primitives to lower-layer IR code, and the partitioner also converts the inputs of operators from global tensor symbols with sharding to local tensor symbols without sharding specifications.</p><p>We could find some clues in <code>tensorflow/compiler/xla/service/spmd/spmd_partitioner_test.cc</code>.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TEST_F</span>(SpmdPartitioningTest, DotPartialContracting2) &#123;</span><br><span class="line">  absl::string_view hlo_string = <span class="string">R&quot;(</span></span><br><span class="line"><span class="string">HloModule module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ENTRY entry &#123;</span></span><br><span class="line"><span class="string">  %lhs = f32[24,100] parameter(0),</span></span><br><span class="line"><span class="string">    sharding=&#123;devices=[1,2,2]0,1,2,3 last_tile_dim_replicate&#125;</span></span><br><span class="line"><span class="string">  %rhs = f32[32,100] parameter(1),</span></span><br><span class="line"><span class="string">    sharding=&#123;devices=[1,2,2]0,1,2,3 last_tile_dim_replicate&#125;</span></span><br><span class="line"><span class="string">  ROOT %dot = f32[24,32] dot(%lhs, %rhs),</span></span><br><span class="line"><span class="string">    lhs_batch_dims=&#123;&#125;, rhs_batch_dims=&#123;&#125;,</span></span><br><span class="line"><span class="string">    lhs_contracting_dims=&#123;1&#125;, rhs_contracting_dims=&#123;1&#125;,</span></span><br><span class="line"><span class="string">    sharding=&#123;devices=[2,1,2]0,2,1,3 last_tile_dim_replicate&#125;</span></span><br><span class="line"><span class="string">&#125;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TF_ASSERT_OK_AND_ASSIGN</span>(<span class="keyword">auto</span> <span class="keyword">module</span>,</span><br><span class="line">                          <span class="built_in">PartitionComputation</span>(hlo_string, <span class="comment">/*num_devices=*/</span><span class="number">4</span>));</span><br><span class="line">  <span class="built_in">VLOG</span>(<span class="number">1</span>) &lt;&lt; <span class="keyword">module</span>-&gt;<span class="built_in">ToString</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">auto</span> lhs = <span class="built_in">AllOf</span>(op::<span class="built_in">Shape</span>(<span class="string">&quot;f32[24,50]&quot;</span>), op::<span class="built_in">Parameter</span>(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">auto</span> rhs = <span class="built_in">AllOf</span>(op::<span class="built_in">Shape</span>(<span class="string">&quot;f32[32,50]&quot;</span>), op::<span class="built_in">Parameter</span>(<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">auto</span> dot =</span><br><span class="line">      <span class="built_in">AllOf</span>(op::<span class="built_in">Shape</span>(<span class="string">&quot;f32[12,32]&quot;</span>),</span><br><span class="line">            op::<span class="built_in">Dot</span>(<span class="built_in">AllOf</span>(op::<span class="built_in">Shape</span>(<span class="string">&quot;f32[12,50]&quot;</span>), op::<span class="built_in">DynamicSlice</span>(lhs, _, _)),</span><br><span class="line">                    rhs));</span><br><span class="line">  <span class="keyword">auto</span> root = <span class="keyword">module</span>-&gt;<span class="built_in">entry_computation</span>()-&gt;<span class="built_in">root_instruction</span>();</span><br><span class="line">  <span class="built_in">EXPECT_THAT</span>(root, op::<span class="built_in">AllReduce</span>(dot));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Two inputs, <code>lhs</code> and <code>rhs</code>, are tensors partitioned in the way that the figure describes. Thus, after partitioning the computation, the <code>lhs</code> is unwarpped, and its shape changed from <code>f32[24, 100]</code> to <code>f32[24,50]</code>. And at the end of file, <code>AllReduce</code> was added to collect the partial results.</p><figure><img data-src="/images/pasted-93.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><h2 id="sharding-propagation-algorithm">Sharding Propagation Algorithm</h2><p>The system should be able to figure out an optimal sharding specifications for the remaining tensors without users annotations. An ideal partitioning plan can reduce the communication amount, reduce memory footprint, and improve the performance.</p><figure><img data-src="/images/pasted-94.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><p>Some unit tests written in <code>tensorflow/compiler/xla/service/sharding_propagation_test.cc</code> are intuitive examples.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TEST_P</span>(ParameterizedMetadataTest, BroadcastForwardPass) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> hlo_string = <span class="string">R&quot;(</span></span><br><span class="line"><span class="string">HloModule module</span></span><br><span class="line"><span class="string">ENTRY %broadcast &#123;</span></span><br><span class="line"><span class="string">  %param0 = f32[3,2048,2048]&#123;2,1,0&#125; parameter(0),</span></span><br><span class="line"><span class="string">    sharding=&#123;devices=[1,2,2]0,1,2,3 metadata=&#123;op_name=&quot;a&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">  %broadcast = f32[3,2048,2048,3]&#123;3,2,1,0&#125; broadcast(%param0), dimensions=&#123;0,1,2&#125;</span></span><br><span class="line"><span class="string">  ROOT %copy = f32[3,2048,2048,3]&#123;3,2,1,0&#125; copy(%broadcast)</span></span><br><span class="line"><span class="string">&#125;)&quot;</span>;</span><br><span class="line">  <span class="built_in">TF_ASSERT_OK_AND_ASSIGN</span>(<span class="keyword">auto</span> <span class="keyword">module</span>,</span><br><span class="line">                          <span class="built_in">ParseAndReturnVerifiedModule</span>(hlo_string));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetParam</span>().clear_metadata) &#123;</span><br><span class="line">    <span class="built_in">ClearMetadata</span>(<span class="keyword">module</span>.<span class="built_in">get</span>());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">TF_ASSERT_OK_AND_ASSIGN</span>(</span><br><span class="line">      <span class="keyword">bool</span> changed,</span><br><span class="line">      <span class="built_in">ShardingPropagation</span>(<span class="comment">/*is_spmd=*/</span><span class="literal">false</span>, <span class="built_in">GetParam</span>().propagate_metadata)</span><br><span class="line">          .<span class="built_in">Run</span>(<span class="keyword">module</span>.<span class="built_in">get</span>()));</span><br><span class="line">  <span class="built_in">EXPECT_TRUE</span>(changed);</span><br><span class="line">  <span class="keyword">auto</span>* instruction = <span class="built_in">FindInstruction</span>(<span class="keyword">module</span>.<span class="built_in">get</span>(), <span class="string">&quot;broadcast&quot;</span>);</span><br><span class="line">  <span class="built_in">ASSERT_NE</span>(instruction, <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="built_in">EXPECT_THAT</span>(instruction, op::<span class="built_in">Sharding</span>(<span class="string">&quot;&#123;devices=[1,2,2,1]0,1,2,3&#125;&quot;</span>));</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">GetParam</span>().propagate_metadata &amp;&amp; !<span class="built_in">GetParam</span>().clear_metadata) &#123;</span><br><span class="line">    <span class="built_in">EXPECT_THAT</span>(instruction-&gt;<span class="built_in">sharding</span>(),</span><br><span class="line">                <span class="built_in">ShardingMetadata</span>(&#123;<span class="built_in">CreateMetadata</span>(<span class="string">&quot;a&quot;</span>)&#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">EXPECT_THAT</span>(instruction-&gt;<span class="built_in">sharding</span>(), <span class="built_in">ShardingMetadata</span>(&#123;&#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>It clearly shows that the system inferred the sharding specification of <code>broadcast</code> is <code>&#123;devices=[1,2,2,1]0,1,2,3&#125;</code>according to its input with the attribute <code>&#123;devices=[1,2,2]0,1,2,3&#125;</code>. Note that this test is called <code>BroadcastForwardPass</code>, there also exists a test named <code>BroadcastBackwardPass</code>, which is to say the propagation should be on both directions.</p><h2 id="reference">Reference</h2><ul><li><p>GShard: https://arxiv.org/abs/2006.16668</p></li><li><p>GSPMD: https://arxiv.org/abs/2105.04663</p></li><li><p>Julia DistributedArrays.jl: https://juliaparallel.github.io/DistributedArrays.jl/latest/index.html</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Recently, a SOTA sharding approach, GSPMD/GShard, was proposed and it provides an intuitive interface to partition a large array on arbitrary dimensions, while utilizing sharding propagation algorithms to automatically infer the partitioning strategy for tensors without user-specified sharding specifications. This document introduces the design and the implementation of XLA Sharding System.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Easy way to debug TensorFlow XLA Compiler using VSCode</title>
    <link href="https://nekodaemon.com/2021/08/04/Easy-way-to-debug-TensorFlow-XLA-Compiler-using-VSCode/"/>
    <id>https://nekodaemon.com/2021/08/04/Easy-way-to-debug-TensorFlow-XLA-Compiler-using-VSCode/</id>
    <published>2021-08-04T13:26:12.000Z</published>
    <updated>2021-08-04T13:29:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>It would be easier to read the source code if we are aware of the runtime information, including call stacks and variable values. This tutorial introduces how to utilize our powerful VSCode to trace XLA Compiler.</p><figure><img data-src="/images/pasted-82.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><h2 id="preparing-environment">Preparing Environment</h2><p>Of course we need to download the source code of TensorFlow, and install all the dependencies. I suggest to use Conda to manage the environment, and use build-in GCC on Ubuntu 18.04 (or above, maybe) to build the code. Note that building from source requires about 50GiB of free space.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fetch Source Code</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/tensorflow/tensorflow.git</span><br><span class="line"><span class="built_in">cd</span> tensorflow</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install dependencies</span></span><br><span class="line">conda create -n tf_dev python numpy wheel -y</span><br><span class="line">conda activate tf_dev</span><br><span class="line">pip install keras_preprocessing</span><br><span class="line">conda install -c conda-forge bazel -y</span><br></pre></td></tr></table></figure><h2 id="compile-the-source-code">Compile the source code</h2><p>First of all, configure the project and build it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">bazel build --config=dbg //tensorflow/tools/pip_package:build_pip_package</span><br></pre></td></tr></table></figure><p>During the configuration process, it is recommended to choose <strong>ALL</strong> the default options if it is not a must to debug on GPU, since enabling GPU support needs additional configuration (Please refer to <a href="https://github.com/tensorflow/tensorflow/blob/master/CONTRIBUTING.md">this article</a>) and much more time to compile.</p><p>As for the bazel build flag,</p><ul><li><code>--config=dbg</code> adds debugging symbols. Required.</li><li><code>--config=monolithic</code> should generate the binary code as a single dynamic library. But this option seems to be buggy. Not recommended.</li></ul><p>Compiling TensorFlow is quite time-consuming, and it took about 20min using 48 CPU threads on my server. Time for coffee now.</p><h2 id="pick-a-unit-test-to-compile">Pick a unit test to compile</h2><p>In fact, we don't have to write something in Python frontend to trigger breakpoints inside XLA compiler, as there are already tons of unit tests that covers most of codes and demonstrates the capability of the compiler.</p><p>Let pick a simple test first to validate the code is compiled correctly.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bazel <span class="built_in">test</span> --config=dbg //tensorflow/compiler/xla/tests:tuple_test_cpu</span><br></pre></td></tr></table></figure><p>From the compiling log, we could find the executable file locates at <code>bazel-bin/tensorflow/compiler/xla/tests/tuple_test_cpu</code>. Execute it! If everything works well, the program will print out the message below.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[----------] Global <span class="built_in">test</span> environment tear-down</span><br><span class="line">[==========] 25 tests from 2 <span class="built_in">test</span> suites ran. (3618 ms total)</span><br><span class="line">[  PASSED  ] 25 tests.</span><br></pre></td></tr></table></figure><p>Then pick a test you interest, and repeat the steps above.</p><h2 id="fix-broken-dependency-optional">Fix broken dependency (Optional)</h2><p>Take <code>spmd_partitioner_test</code> as an example. This unit test can be compiled without any error message, but when you directly run the executable, you will see this message.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ RUN      ] SpmdPartitioningTest.BroadcastAsReplicate3</span><br><span class="line">2021-08-04 10:44:13.324501: I tensorflow/compiler/xla/service/platform_util.cc:72] platform Host present but no XLA compiler available: could not find registered compiler for platform Host -- check target linkage (hint: try adding tensorflow/compiler/jit:xla_cpu_jit as a dependency)</span><br><span class="line">[       OK ] SpmdPartitioningTest.BroadcastAsReplicate3 (6 ms)</span><br></pre></td></tr></table></figure><p>This is because this executable is not linked to a valid backend, which means this executable doesn't contain the code of JIT Execution Environment. The solution is modifying the <code>BUILD</code> file manually to fix the dependency as the message suggests.</p><p>Open the <code>BUILD</code> file in the directory where the unit test locates. In this example, the test <code>tensorflow/compiler/xla/service/spmd/spmd_partitioner_test.cc</code> corresponds to <code>tensorflow/compiler/xla/service/spmd/BUILD</code>. And add this dependency <code>//tensorflow/compiler/jit:xla_cpu_jit</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tf_cc_test(</span><br><span class="line">    name = <span class="string">&quot;spmd_partitioner_test&quot;</span>,</span><br><span class="line">    srcs = [<span class="string">&quot;spmd_partitioner_test.cc&quot;</span>],</span><br><span class="line">    deps = [</span><br><span class="line">        <span class="string">&quot;:spmd_partitioner&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla:util&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla:xla_data_proto_cc&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/service:hlo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/service:hlo_casting_utils&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/service:hlo_matchers&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/service:hlo_parser&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/service:hlo_pass_pipeline&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/service:hlo_verifier&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/tests:hlo_test_base&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/xla/tests:xla_internal_test_main&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/compiler/jit:xla_cpu_jit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;//tensorflow/core:test&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="configuring-vscode">Configuring VSCode</h2><p>Since the unit test was built as an executable with debugging symbols, there is nothing special about the configuration of VSCode. Install <code>C/C++</code> Extension, and write the following lines to <code>.vscode/launch.json</code>.</p><blockquote><p>You could open that json file by clicking <code>ctrl/command</code>+<code>shift</code>+<code>p</code>, typing <code>launch.json</code>, and selecting <code>Add Configuration</code> -&gt; <code>C/C++: (gdb) Launch</code></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;(gdb) Launch&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppdbg&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/bazel-bin/tensorflow/compiler/xla/service/spmd/spmd_partitioner_test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;args&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;stopAtEntry&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;environment&quot;</span>: [],</span><br><span class="line">  <span class="attr">&quot;externalConsole&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;gdb&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;setupCommands&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Enable pretty-printing for gdb&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;-enable-pretty-printing&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;ignoreFailures&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Everything is all set! Press <code>F5</code> to start debugging.</p><h2 id="reference">Reference</h2><ul><li><a href="https://www.tensorflow.org/install/source#ubuntu">https://www.tensorflow.org/install/source#ubuntu</a></li><li><a href="https://github.com/tensorflow/tensorflow/blob/master/CONTRIBUTING.md">https://github.com/tensorflow/tensorflow/blob/master/CONTRIBUTING.md</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;It would be easier to read the source code if we are aware of the runtime information, including call stacks and variable values. This tutorial introduces how to utilize our powerful VSCode to trace XLA Compiler.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>ASC20-21 - </title>
    <link href="https://nekodaemon.com/2021/05/15/ASC20-21%E5%9B%9E%E9%A1%BE-%E5%A4%A7%E5%AE%B6%E9%83%BD%E3%80%87%E7%AD%89%E4%BA%8E%E5%A4%A7%E5%AE%B6%E9%83%BD%E6%B2%A1%E3%80%87/"/>
    <id>https://nekodaemon.com/2021/05/15/ASC20-21%E5%9B%9E%E9%A1%BE-%E5%A4%A7%E5%AE%B6%E9%83%BD%E3%80%87%E7%AD%89%E4%BA%8E%E5%A4%A7%E5%AE%B6%E9%83%BD%E6%B2%A1%E3%80%87/</id>
    <published>2021-05-15T14:02:15.000Z</published>
    <updated>2021-05-15T14:03:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>ASC20ASC20ASC20-21-=2<del></del></p><h2 id="day-0">Day 0</h2><p>Day0    <del>1080Xeon Phi</del>GPU1GPU2GPU13NUMA   </p><p>NASAHCIHPEBIOSAHCIRAIDRAIDRAIDU </p><p>nvidia-smiA100A1007.5w1080GPU3A100GPU2GPU13<del></del>12<del></del>GPU3GPU<del></del></p><p>BMCPCIeRiserRiser</p><p>TP-Link</p><p>HPL7kw    </p><p>BeeGFSNFSBeeGFSCephNFSNFSfstabxfsmountNFSNFSRace conditionRace conditionfstabNFS</p><p>THUSJTUAP</p><figure><img data-src="/images/pasted-70.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><p>GrafanaDashboardDHTMLXFlask        <del>json</del>Jetson Nanoclusterssh</p><figure><img data-src="/images/pasted-71.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><center><i>NODEDETAILCONSOLE</i></center><h2 id="day-1">Day 1</h2><p>Day 1Day 2IPDHCPhosts</p><p>CPUC StateP Statedmesg<code>intel_idle: does not run on family 6 model</code>Ubuntu 18.045.4 HWE<code>cpupower idle-info</code>C6 StateUbuntu 18.045.10deb<code>intel_idle</code>C6NVIDIACPUCPUCPU</p><blockquote><p></p><ul><li><a href="https://support.huawei.com/enterprise/en/doc/EDOC1000039573/b029a50b/advanced-power-management-configuration">https://support.huawei.com/enterprise/en/doc/EDOC1000039573/b029a50b/advanced-power-management-configuration</a></li><li><a href="https://wiki.bu.ost.ch/infoportal/_media/embedded_systems/ethercat/controlling_processor_c-state_usage_in_linux_v1.1_nov2013.pdf">https://wiki.bu.ost.ch/infoportal/_media/embedded_systems/ethercat/controlling_processor_c-state_usage_in_linux_v1.1_nov2013.pdf</a></li><li><a href="https://vstinner.github.io/intel-cpus.html">https://vstinner.github.io/intel-cpus.html</a></li></ul></blockquote><p>ASCPTSD3232GPU100Wtm</p><p>BMCBMCASC19BMCload resistance</p><p>HPLHPCGHPLHPCG</p><p>400W1kW+GPUGPUHPLQuEST</p><h2 id="day-2">Day 2</h2><p>HPL<del></del></p><figure><img data-src="/images/pasted-72.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><p>HPLHPLHPLHPLHPLHPLlogemmmHPCGHPCG</p><p>HPLPRESTOGBIONFS over 1Gbps EthernetMPISSDPRESTOSSDIP over IBscpSSDNFS over IP over IBNFS over RDMAMPIBeeGFSIBNFS over RDMAmountdmesgPRESTOdstatIO</p><p>HPLMPIHPLHPL</p><p>PRESTOMPIPRESTO</p><p>USSDumountiostatUrsynccpSSDumount</p><p><del></del></p><h2 id="day-3">Day 3</h2><p>Day 2Day 3QuEST<del></del>34320G332035~36CPUGPU</p><p>AIQuESTGPUQuESTDay 3AIBERTBERTDay 3ALBERTBERT   lossbugEpochEpochEpochEpochcheckpointlog     log</p><p>AIQuESTCPUMPIOMPMPImpirunIntel MPIOpenMPI<code>map-by</code><code>bind-to</code>Intel MPIgenvMPIOMPIntel<code>-print-rank-map</code>slurmIntel MPIslurm<code>slurmd -c</code>slurmslurmQuESTmpirunulimitulimitunlimitedroot</p><p>1logslurmkillhtopslurmkillAIQuESThtopQuESTrankrankslurmQuEST</p><p>QuESTMakefileQuESTCMakeMakefilecppcpppyPython</p><p>1AIAIEpochCtrl-CslurmAIKeyboard InterruptlogCtrl-C40078%Epoch85%Anyway400</p><h2 id="day-4">Day 4</h2><p>prerankDay 3</p><p>GPUQuESTRankStateVectorRankGPUCPUASCPBNFS100</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ASC20ASC20ASC20-21-=2&lt;del&gt;&lt;/del&gt;&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>How to make an unattended Ubuntu Server Installation ISO with cloud-init</title>
    <link href="https://nekodaemon.com/2021/04/27/How-to-make-an-unattended-Ubuntu-Server-Installation-ISO-with-cloud-init/"/>
    <id>https://nekodaemon.com/2021/04/27/How-to-make-an-unattended-Ubuntu-Server-Installation-ISO-with-cloud-init/</id>
    <published>2021-04-27T09:36:02.000Z</published>
    <updated>2022-01-15T16:58:19.000Z</updated>
    
    <content type="html"><![CDATA[<p><em>Updated on 16 Jan, 2022</em>. I worte <a href="/2022/01/16/Unattended-Ubuntu-20-04-Server-Offline-Installation/">a post for Ubuntu 20.04 Server</a>.</p><p>It will be convenient if the installation is fully automated when configuring multiple nodes at the same time. However, I believe Ubuntu doesn't care about unattended installation via the CD image. Its developers seem to be unwilling to write a detailed tutorial about that, even some changes they made make trouble unintentionally. Note that installing via PXE Network Boot is a good alternative.</p><h2 id="before-getting-hands-dirty">Before getting hands dirty</h2><p>An unnoticeable fact is that Ubuntu Server replaced its installer silently, which means some tutorials are actually not applicable for specific versions of Ubuntu. According to my observation, we have two installers so far,</p><ul><li>Before Ubuntu 18.04.3: <code>Debian-Installer</code>, a non-live installer</li><li>Ubuntu 18.04.4~18.04.5: <del>Old version of <code>subiquity</code>, a live installer, <strong>without unattended installation support</strong></del><ul><li>There are two varients, (thanks for jack's comment)<ul><li>one is called <code>non-live</code> version with <code>Debian-Installer</code></li><li>another is called <code>live</code> version with old version of <code>subiquity</code>, which doesn't have unattended installation support</li></ul></li></ul></li><li>Ubuntu 20.04: <code>subiquity</code>, a live installer, with unattended installation support</li></ul><p>Consider that Ubuntu 18.04 has excellent compatibility, this tutorial aims at <strong>making Ubuntu 18.04.5 Installation ISO</strong>. As for Ubuntu 20.04 users, please refer to this tutorial <a href="https://gist.github.com/s3rj1k/55b10cd20f31542046018fcce32f103e">https://gist.github.com/s3rj1k/55b10cd20f31542046018fcce32f103e</a> or <a href="/2022/01/16/Unattended-Ubuntu-20-04-Server-Offline-Installation/">my newer blog post</a> for your information, and you can still read this tutorial because some approaches mentioned in this article also work.</p><h2 id="download-iso-and-tools">Download ISO and Tools</h2><p><del>Since Ubuntu 18.04.4~18.04.5 doesn't support unattended installation, we have to use Ubuntu 18.04.3 as the original version. Note that this version is deprecated. Thus it can only be downloaded from <code>old-releases</code> site.</del> Make sure what you download is a <code>non-live</code> version, such as,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://old-releases.ubuntu.com/releases/18.04.3/ubuntu-18.04.3-server-amd64.iso</span><br></pre></td></tr></table></figure><p>There is an excellent tool called <code>cubic</code>, which helps us decompress and repack the ISO file and <code>rootfs</code> image. Also, it will automatically set up the virtual environment (<code>chroot</code>), where modifying the root filesystem is quite easy, just like operating a regular Ubuntu.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-add-repository ppa:cubic-wizard/release</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install cubic</span><br></pre></td></tr></table></figure><p>Run <code>cubic</code> command in the terminal to launch this program.</p><h2 id="modify-root-filesystem">Modify Root Filesystem</h2><p>Generally speaking, all the files existing in the virtual environment will be directly copied to the machine where this system is installed, except several files generated during installation. Thus, you can preinstall some software in this step.</p><figure><img data-src="/images/pasted-69.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><h3 id="install-and-upgrade-software">Install and Upgrade Software</h3><p>Consider that Ubuntu 18.04.3 is a bit outdated, so some build-in software should be upgraded.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt update &amp;&amp; apt upgrade -y</span><br></pre></td></tr></table></figure><blockquote><p>Note:</p><ul><li>The Linux Kernel has been installed in this stage, and it will be installed by <code>Debian-installer</code> during installation. Therefore, you still need to perform <code>apt upgrade</code> after installation.</li><li>You can change an APT repository in the virtual environment, but the file <code>/etc/apt/source.list</code> will be replaced by <code>Debian-installer</code> or <code>cloud-init</code> eventually.</li><li>SSH server could be installed in advance to save some time in installing OS, and <code>cloud-init</code> will regenerate SSH-key during the first boot.</li></ul></blockquote><h3 id="write-post-installation-script">Write Post-Installation Script</h3><p><code>cloud-init</code> is widely used in the cloud industry to initialize the system during the first boot. In fact, we could utilize it to do post-installation configuration. It is recommended to refer to these examples to customize your script: <a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html">https://cloudinit.readthedocs.io/en/latest/topics/examples.html</a>.</p><p>I attach my script located at <code>/etc/cloud/cloud.cfg.d/20-asc-init.cfg</code> here for your reference.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"></span><br><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">disabled</span></span><br><span class="line"><span class="attr">bootcmd:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/usr/bin/asc_init_net</span></span><br><span class="line"><span class="attr">ntp:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">apt:</span></span><br><span class="line">  <span class="attr">primary:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">arches:</span> [<span class="string">default</span>]</span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://mirrors.sustech.edu.cn/ubuntu/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">package_update:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">package_upgrade:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">power_state:</span></span><br><span class="line">  <span class="attr">mode:</span> <span class="string">reboot</span></span><br></pre></td></tr></table></figure><h3 id="optional-configure-dhcp-for-all-network-interfaces-after-installation">Optional: Configure DHCP for all network interfaces after installation</h3><p><code>Debian-installer</code> has a known bug: <code>netcfg/choose_interface=auto</code> fails to pick the functional network interface from many ones. Meanwhile, <code>cloud-init</code> also only configure one interface since most of the cloud instances only have one. If your machine happens to have one interface, you can skip this part. Otherwise, you need a workaround.</p><p>I wrote a script <code>/usr/bin/asc_init_net</code> to automatically generate configuration file for <code>Netplan</code> during post-installation. All interfaces will contact the DHCP server to get available IP addresses simultaneously. Of course, this script should be executed by <code>cloud-init</code> as <code>bootcmd</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">find /sys/class/net -<span class="built_in">type</span> l -not -lname <span class="string">&#x27;*virtual*&#x27;</span> -<span class="built_in">printf</span> <span class="string">&#x27;%f\n&#x27;</span> | python3 -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">import sys</span></span><br><span class="line"><span class="string">import yaml</span></span><br><span class="line"><span class="string">c = &#123;</span></span><br><span class="line"><span class="string">    &#x27;network&#x27;: &#123;</span></span><br><span class="line"><span class="string">        &#x27;version&#x27;: 2,</span></span><br><span class="line"><span class="string">        &#x27;ethernets&#x27;: &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">for i in sys.stdin.readlines():</span></span><br><span class="line"><span class="string">    c[&#x27;network&#x27;][&#x27;ethernets&#x27;][i.strip()] = &#123;&#x27;dhcp4&#x27;: True, &#x27;optional&#x27;: True&#125;</span></span><br><span class="line"><span class="string">print(yaml.dump(c))</span></span><br><span class="line"><span class="string">&quot;</span> &gt; /etc/netplan/20-asc-init.yaml &amp;&amp; netplan apply</span><br></pre></td></tr></table></figure><p>Don't forget to set the correct permission.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/bin/asc_init_net</span><br></pre></td></tr></table></figure><h3 id="clean-up">Clean up</h3><p><code>/etc/machine-id</code> might be generated when you install some software or do something else. However, this ID should vary from machine to machine. If two machines share the same ID, they may get the same IP address from the DHCP server. Therefore, this file should keep empty.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n &gt; /etc/machine-id</span><br></pre></td></tr></table></figure><blockquote><p>Note: This file could be regenerated by running <code>systemd-machine-id-setup</code> or rebooting the computer.</p></blockquote><p>Moreover, <code>cloud-init</code> will be executed on the next boot only if it is clean, then it will write something to disk to prevent itself from running again. To make sure it will work as expected, we can clean it manually.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cloud-init clean</span><br></pre></td></tr></table></figure><h2 id="write-preseed-file">Write Preseed File</h2><p>Preseed files store all the answers to the questions that the installer asks. Move to the directory <code>custom-disk</code>, which is created by <code>cubic</code> and contains the supporting files of the CD, including bootloaders and some configuration. Create a file <code>custom-disk/preseed/auto-inst.seed</code>, and write the following content to that file.</p><figure><img data-src="/images/pasted-68.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Automatic Installation</span></span><br><span class="line">d-i auto-install/<span class="built_in">enable</span> boolean <span class="literal">true</span></span><br><span class="line">d-i debconf/priority select critical</span><br><span class="line"></span><br><span class="line"><span class="comment">### Localization</span></span><br><span class="line">d-i debian-installer/locale string en_US.UTF-8</span><br><span class="line">d-i localechooser/supported-locales multiselect en_US.UTF-8</span><br><span class="line">d-i console-setup/ask_detect boolean <span class="literal">false</span></span><br><span class="line">d-i keyboard-configuration/xkb-keymap select us</span><br><span class="line"></span><br><span class="line"><span class="comment">### Network config</span></span><br><span class="line">d-i netcfg/<span class="built_in">enable</span> boolean <span class="literal">false</span></span><br><span class="line"><span class="comment">#d-i netcfg/choose_interface select auto</span></span><br><span class="line"><span class="comment">#d-i netcfg/get_hostname string node0</span></span><br><span class="line"><span class="comment">#d-i netcfg/get_domain string unassigned-domain</span></span><br><span class="line"><span class="comment">#d-i netcfg/hostname string node0</span></span><br><span class="line">d-i hw-detect/load_firmware boolean <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Mirror settings</span></span><br><span class="line">d-i apt-setup/use_mirror boolean <span class="literal">false</span></span><br><span class="line"><span class="comment">#d-i mirror/http/mirror select CC.archive.ubuntu.com</span></span><br><span class="line"><span class="comment">#d-i mirror/country string manual</span></span><br><span class="line"><span class="comment">#d-i mirror/http/hostname string mirrors.sustech.edu.cn</span></span><br><span class="line"><span class="comment">#d-i mirror/http/directory string /ubuntu</span></span><br><span class="line"><span class="comment">#d-i mirror/http/proxy string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Account setup</span></span><br><span class="line"><span class="comment"># This is just for testing!!!</span></span><br><span class="line">d-i passwd/make-user boolean <span class="literal">false</span></span><br><span class="line">d-i passwd/user-fullname string Ubuntu User</span><br><span class="line">d-i passwd/username string ubuntu</span><br><span class="line">d-i passwd/user-password password ubuntu</span><br><span class="line">d-i passwd/user-password-again password ubuntu</span><br><span class="line"><span class="comment">#d-i passwd/user-password-crypted password [crypt(3) hash]</span></span><br><span class="line">d-i user-setup/allow-password-weak boolean <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set to true if you want to encrypt the first user&#x27;s home directory.</span></span><br><span class="line">d-i user-setup/encrypt-home boolean <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Clock and time zone setup</span></span><br><span class="line">d-i clock-setup/utc boolean <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You may set this to any valid setting for $TZ; see the contents of</span></span><br><span class="line"><span class="comment"># /usr/share/zoneinfo/ for valid values.</span></span><br><span class="line">d-i time/zone string Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls whether to use NTP to set the clock during the install</span></span><br><span class="line">d-i clock-setup/ntp boolean <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Partitioning</span></span><br><span class="line"><span class="comment"># !!!DANGER don&#x27;t use this without knowing what you are doing!!!</span></span><br><span class="line"><span class="comment"># comment out this block it you want the installer to ask about the </span></span><br><span class="line"><span class="comment"># partitioning, which is much safer!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The following will partition disk /dev/sda with an EFI partition, a root partition</span></span><br><span class="line"><span class="comment"># and a swap file. AND WONT ASK TO CONFIRM ANYTHING i.e. it will overwrite existing partitions</span></span><br><span class="line">d-i preseed/early_command string umount /media || <span class="literal">true</span></span><br><span class="line">d-i partman/unmount_active boolean <span class="literal">true</span></span><br><span class="line">d-i partman-auto/disk string /dev/sda</span><br><span class="line">d-i partman-auto/method string regular</span><br><span class="line">d-i partman-auto/choose_recipe select atomic</span><br><span class="line">d-i partman-partitioning/confirm_write_new_label boolean <span class="literal">true</span></span><br><span class="line">d-i partman/choose_partition select finish</span><br><span class="line">d-i partman/confirm boolean <span class="literal">true</span></span><br><span class="line">d-i partman/confirm_nooverwrite boolean <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The kernel image (meta) package to be installed;</span></span><br><span class="line">d-i base-installer/kernel/image string linux-generic</span><br><span class="line"><span class="comment">#d-i base-installer/kernel/altmeta string hwe-18.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Package selection</span></span><br><span class="line"><span class="comment"># Install the Ubuntu Server seed.</span></span><br><span class="line"><span class="comment">#tasksel tasksel/force-tasks string server</span></span><br><span class="line"><span class="comment">#tasksel tasksel/first multiselect openssh-server</span></span><br><span class="line">d-i tasksel/first multiselect none</span><br><span class="line">d-i pkgsel/language-packs multiselect en, zh</span><br><span class="line">d-i pkgsel/update-policy select none</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verbose output and no boot splash screen.</span></span><br><span class="line">d-i debian-installer/quiet  boolean <span class="literal">false</span></span><br><span class="line">d-i debian-installer/splash boolean <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">d-i cdrom-detect/eject boolean <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Avoid that last message about the install being complete.</span></span><br><span class="line"><span class="comment"># This will just finish and reboot</span></span><br><span class="line">d-i finish-install/reboot_in_progress note</span><br><span class="line"><span class="comment">#d-i debian-installer/exit/poweroff boolean true</span></span><br></pre></td></tr></table></figure><blockquote><p>Note: The network is disabled during the installation due the problem we talked about earlier. As a result, <code>debian-install</code> will</p><ul><li>Fail to use self-defined APT repository</li><li>Skip setting the host name</li><li>Skip configuring <code>netplan</code></li></ul><p>But, all the problems above can be fixed by <code>cloud-init</code>.</p></blockquote><h2 id="add-boot-arguments">Add Boot Arguments</h2><p>Automatic installation requires us to pass extra arguments to the kernel. Luckily, <code>cubic</code> will help us to edit the configuration of bootloaders.</p><blockquote><p>Note: There are two bootloaders in the CD image. <code>grub</code> is used to support the <code>EFI</code> firmware, and <code>isolinux</code> is used to support the traditional BIOS.</p></blockquote><p>Write the content below to the corresponding file.</p><h3 id="bootgrubgrub.cfg"><code>boot/grub/grub.cfg</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> loadfont /boot/grub/font.pf2 ; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">set</span> gfxmode=auto</span><br><span class="line">insmod efi_gop</span><br><span class="line">insmod efi_uga</span><br><span class="line">insmod gfxterm</span><br><span class="line">terminal_output gfxterm</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> menu_color_normal=white/black</span><br><span class="line"><span class="built_in">set</span> menu_color_highlight=black/light-gray</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> timeout=3</span><br><span class="line">menuentry <span class="string">&quot;Auto Install Ubuntu Server&quot;</span> &#123;</span><br><span class="line"><span class="built_in">set</span> gfxpayload=keep</span><br><span class="line">linux /install/vmlinuz boot=casper file=/cdrom/preseed/auto-inst.seed auto=<span class="literal">true</span> priority=critical locale=en_US quiet ---</span><br><span class="line">initrd  /install/initrd.gz</span><br><span class="line">&#125;</span><br><span class="line">menuentry <span class="string">&quot;Rescue a broken system&quot;</span> &#123;</span><br><span class="line"><span class="built_in">set</span> gfxpayload=keep</span><br><span class="line">linux /install/vmlinuz boot=casper rescue/<span class="built_in">enable</span>=<span class="literal">true</span> ---</span><br><span class="line">initrd /install/initrd.gz</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="isolinuxtxt.cfg"><code>isolinux/txt.cfg</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">default autoinstall</span><br><span class="line">label  auto-install</span><br><span class="line">  menu label ^Auto Install Ubuntu Server</span><br><span class="line">  kernel /install/vmlinuz</span><br><span class="line">  append boot=casper file=/cdrom/preseed/auto-inst.seed vga=788 initrd=/install/initrd.gz auto=<span class="literal">true</span> priority=critical locale=en_US quiet ---</span><br></pre></td></tr></table></figure><blockquote><p>Note: <code>isolinux</code> has a build-in option <code>Rescue a broken system</code>.</p></blockquote><p>By now, everything is ready to go. Let us enjoy the automatic installation.</p><h2 id="reference">Reference</h2><ul><li><a href="https://www.pugetsystems.com/labs/hpc/Note-Auto-Install-Ubuntu-with-Custom-Preseed-ISO-1654/">https://www.pugetsystems.com/labs/hpc/Note-Auto-Install-Ubuntu-with-Custom-Preseed-ISO-1654/</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;em&gt;Updated on 16 Jan, 2022&lt;/em&gt;. I worte &lt;a href=&quot;/2022/01/16/Unattended-Ubuntu-20-04-Server-Offline-Installation/&quot;&gt;a post for Ubuntu 20.04 Server&lt;/a&gt;.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Use tmux to debug distributed Python programs</title>
    <link href="https://nekodaemon.com/2021/03/06/Use-tmux-to-debug-distributed-Python-programs/"/>
    <id>https://nekodaemon.com/2021/03/06/Use-tmux-to-debug-distributed-Python-programs/</id>
    <published>2021-03-06T06:29:37.000Z</published>
    <updated>2021-03-07T05:51:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>It is always hard to debug distributed programs. Not only the concurrency is extremely naughty, but we don't have enough tools, or don't know there are several tools to debug the distributed programs. But I found that tmux is capable of handling multiple windows, which means it's possible to control numerous nodes without GUI.</p><h2 id="usage-of-tmux">Usage of tmux</h2><p>Here is my tmux cheating sheet. For more details, check the website <a href="https://gist.github.com/henrik/1967800">https://gist.github.com/henrik/1967800</a>.</p><h3 id="create-session-and-window">Create Session and Window</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shell Commands</span></span><br><span class="line">tmux new -s s1 <span class="comment"># Create a session named s1</span></span><br><span class="line">tmux neww -t s1: htop <span class="comment"># Create a window in session s1 and launch htop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tmux Control</span></span><br><span class="line">Ctrl-b 0 <span class="comment"># Switch to window 0</span></span><br><span class="line">Ctrl-b 1 <span class="comment"># Switch to window 1</span></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="window-pane-conversion">Window / Pane Conversion</h3><p>Note: You are allowed to use autocomplete by clicking <code>tab</code> or check the history by clicking arrow keys after press <code>Ctrl-b</code> and <code>:</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ctrl-b :join-pane -s :2 <span class="comment"># Move window 2 into a new split pane</span></span><br><span class="line">Ctrl-b :break-pane <span class="comment"># Move all inactive panes into windows</span></span><br></pre></td></tr></table></figure><p>Sometimes <code>-t</code> represents <code>target</code> while <code>-s</code> represents <code>source</code>.</p><h2 id="example">Example</h2><h3 id="rpc-via-ssh">RPC via SSH</h3><p>This is a launcher which will spawn several processes on remote machines. (Source: DGL Library)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_remote</span>(<span class="params">cmd, ip, port, thread_list</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;execute command line on remote machine via ssh&quot;&quot;&quot;</span></span><br><span class="line">    cmd = <span class="string">&#x27;ssh -o StrictHostKeyChecking=no -p &#x27;</span> + <span class="built_in">str</span>(port) + <span class="string">&#x27; &#x27;</span> + ip + <span class="string">&#x27; \&#x27;&#x27;</span> + cmd + <span class="string">&#x27;\&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># thread func to run the job</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">cmd</span>):</span></span><br><span class="line">        subprocess.check_call(cmd, shell = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    thread = Thread(target = run, args=(cmd,))</span><br><span class="line">    thread.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    thread.start()</span><br><span class="line">    thread_list.append(thread)</span><br></pre></td></tr></table></figure><p>To debug the program, we need to create a session on the login node first.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login$ tmux new -s dgl</span><br></pre></td></tr></table></figure><p>Then modify the source code of the launcher to let newly spawned processes attach to tmux.</p><ul><li>Put <code>tmux neww</code> at the beginning of the command</li><li>Put <code>;bash -i</code> at the end to prevent window from closing after program exited</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_remote</span>(<span class="params">cmd, ip, port, thread_list</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;execute command line on remote machine via ssh&quot;&quot;&quot;</span></span><br><span class="line">    cmd = <span class="string">&#x27;tmux neww -t dgl: ssh -o StrictHostKeyChecking=no -p &#x27;</span> + <span class="built_in">str</span>(port) + <span class="string">&#x27; &#x27;</span> + ip + <span class="string">&#x27; \&#x27;&#x27;</span> + cmd + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&#x27;;bash -i&#x27;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>Finally execute the modified launcher on login node directly. After that we could notice several windows are created and shown at the bottom of tmux.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login$ python launch.py ...</span><br></pre></td></tr></table></figure><h3 id="rpc-via-mpi">RPC via MPI</h3><p>Just like what the previous section does, add something at the beginning or the end of the command.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tmux new -s mpi</span><br><span class="line">mpirun -n 4 tmux neww -t mpi: <span class="string">&quot;python ...; bash -i&quot;</span></span><br></pre></td></tr></table></figure><h2 id="with-debugger">with Debugger</h2><p>It is easier to debug distributed programs when each remote process shown in a separated window is attached by a separated debugger.</p><h3 id="pdb">PDB</h3><p>PDB is a built-in utility, and it is easy to use, especially it allows the program to trap in interactive debugging mode by inserting one instruction explictly. For example, try to execute the following code.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line">pdb.set_trace()</span><br></pre></td></tr></table></figure><p>Then your Python program will pause and a interactive dialogue like <code>gdb</code> appeared.</p><h3 id="pudb">PUDB</h3><p>This is basically PDB equipped with TUI (Text-based user interface), and its usage is quite similar to PDB's. But you have to download it before using it.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda install pudb <span class="comment"># Install by conda</span></span><br><span class="line">pip install pudb <span class="comment"># Install by pip</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pudb</span><br><span class="line">pdb.set_trace()</span><br></pre></td></tr></table></figure><p>However, the TUI heavily relies on some features of pseudo-tty. Without it, the TUI cannot work correctly. But, by default SSH will not allocate pseudo-tty when using SSH to launch a remote program instead of a console. Thus, we need to do some modifications to the launcher.</p><ul><li>specify a SSH argument <code>-t</code> to force pseudo-tty allocation.</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_remote</span>(<span class="params">cmd, ip, port, thread_list</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;execute command line on remote machine via ssh&quot;&quot;&quot;</span></span><br><span class="line">    cmd = <span class="string">&#x27;tmux neww -t dgl: ssh -t -o StrictHostKeyChecking=no -p &#x27;</span> + <span class="built_in">str</span>(port) + <span class="string">&#x27; &#x27;</span> + ip + <span class="string">&#x27; \&#x27;&#x27;</span> + cmd + <span class="string">&#x27;\&#x27;&#x27;</span> + <span class="string">&#x27;;bash -i&#x27;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><figure><img data-src="/images/pasted-67.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><h2 id="reference">Reference</h2><ul><li><a href="https://unix.stackexchange.com/questions/14300/moving-tmux-pane-to-window">https://unix.stackexchange.com/questions/14300/moving-tmux-pane-to-window</a></li><li><a href="https://unix.stackexchange.com/questions/17116/prevent-pane-window-from-closing-when-command-completes-tmux">https://unix.stackexchange.com/questions/17116/prevent-pane-window-from-closing-when-command-completes-tmux</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;It is always hard to debug distributed programs. Not only the concurrency is extremely naughty, but we don&#39;t have enough tools, or don&#39;t know there are several tools to debug the distributed programs. But I found that tmux is capable of handling multiple windows, which means it&#39;s possible to control numerous nodes without GUI.&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>OpenWRTSwitch</title>
    <link href="https://nekodaemon.com/2021/03/02/OpenWRT%E8%B7%AF%E7%94%B1%E5%99%A8%E5%8A%A0%E9%80%9FSwitch%E8%81%94%E6%9C%BA%E7%9A%84%E6%96%B9%E6%A1%88/"/>
    <id>https://nekodaemon.com/2021/03/02/OpenWRT%E8%B7%AF%E7%94%B1%E5%99%A8%E5%8A%A0%E9%80%9FSwitch%E8%81%94%E6%9C%BA%E7%9A%84%E6%96%B9%E6%A1%88/</id>
    <published>2021-03-01T16:37:09.000Z</published>
    <updated>2021-03-01T16:38:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>SwitchNAT TypeNAT TypeSwitchNAT Type</p><h2 id=""></h2><p>NATTCPUDP</p><h2 id="nat-type">NAT Type</h2><p>NAT TypeRFC 3489SymmetricFull ConeNATUDPNAT<del>CF</del></p><p>SwitchNAT Type ARFC 3489<strong>Full Cone</strong><del>P2P</del>Type CD</p><figure><img data-src="https://user-images.githubusercontent.com/63339210/107102123-5ed9d900-6811-11eb-9c00-6165ed9c18a2.gif" alt="img" /><figcaption>img</figcaption></figure><h2 id=""></h2><p><del>DMZ</del>HTTP<strong>Switch</strong></p><h3 id="dmz"><del>DMZ</del></h3><p>luanDMZNAT Type</p><ul><li>ISPIP</li><li></li><li></li></ul><p>IPIPSwitch</p><h3 id="http">HTTP</h3><p>luanTCPNAT Type<strong>HTTPUDP</strong>UDP</p><h3 id=""></h3><p>GatewayGatewaySwitchModem<strong>TCPUDP</strong></p><p>NATIPIPVPSSwitchVPSIPIP</p><p><strong></strong>SwitchVPSVPSIPIP</p><p>SwitchType A<del>SVIP</del></p><figure><img data-src="https://www.globalspec.com/ImageRepository/LearnMore/20164/556af08d5e43aa768260f9e589dc547f-30246b5198cb214841beb88cefade318458a.png" alt="Network Diagram with Gateway Server via HowToForge" /><figcaption>Network Diagram with Gateway Server via HowToForge</figcaption></figure><h2 id=""></h2><p></p><h3 id=""></h3><p></p><ul><li>ShadowsocksSSSSRSSRR</li><li>V2RayV2RayV2FlyXray</li><li>Trojan</li></ul><p>V2RayXrayXrayV2RayUDP<a href="https://v2xtls.org/-udp-/"> UDP  - V2Ray XTLS (v2xtls.org)</a>Xray<strong>Xray</strong>V2Ray</p><p>ShadowsocksTrojan</p><h3 id=""></h3><p>V2Ray<strong>Xray</strong>Full ConeNATUDPissue<a href="https://github.com/V2Ray/V2Ray-core/issues/1614">6Origin</a>Docker</p><h3 id=""></h3><p><a href="https://www.solarck.com/openwrt-V2Ray.html">V2Ray  | Solarck</a><strong>OpenWRT</strong>SnapshotOpenWRT</p><h3 id="v2ray">V2Ray</h3><p>V2RayUDPV2Ray<a href="https://github.com/XTLS/Xray-core/releases">https://github.com/XTLS/Xray-core/releases</a>XrayCPU<code>armv7a</code><code>x64</code><code>scp</code><code>wget</code><code>xray</code><code>/usr/bin/v2ray</code>OpenWRTV2RayV2RayXray</p><figure><img data-src="/images/pasted-63.png" alt="img" /><figcaption>img</figcaption></figure><h3 id=""></h3><p>SwitchNAT Type AVPS</p><p>Windows<a href="https://github.com/HMBSbige/NatTypeTester">NatTypeTester</a>Windows</p><figure><img data-src="/images/pasted-64.png" alt="img" /><figcaption>img</figcaption></figure><h2 id=""></h2><p>SwitchYouTubeVPSVPS</p><h2 id=""></h2><ul><li><a href="https://v2xtls.org/-udp-/"> UDP  - V2Ray XTLS (v2xtls.org)</a></li><li><a href="https://www.solarck.com/openwrt-V2Ray.html">V2Ray  | Solarck</a></li><li><a href="https://github.com/V2Ray/V2Ray-core/issues/1614">6Origin</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;SwitchNAT TypeNAT TypeSwitchNAT Type&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Understanding MPI map-by and bind-to option</title>
    <link href="https://nekodaemon.com/2021/02/05/Understanding-MPI-map-by-and-bind-to-option/"/>
    <id>https://nekodaemon.com/2021/02/05/Understanding-MPI-map-by-and-bind-to-option/</id>
    <published>2021-02-05T10:47:19.000Z</published>
    <updated>2021-02-05T10:59:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>This tutorial will introduce how to utilize <code>map-by</code> option to deal with many complex scenarios such as running a hybrid MPI program (mixture of OpenMP and MPI).</p><h2 id="before-starting">Before starting</h2><p>The behavior of MPI varies significantly if the environment changes (including MPI version and implementations, dependent libraries, and job schedulers). All the experiments mentioned in this article are conducted on <strong>OpenMPI 4.0.2</strong>, which means if you use different implementations or versions of MPI, you may encounter unexpected problems. For example, OpenMPI 2.1.1, the default version bundled in Ubuntu 18.04, will behave strangely and fail to control the number of OpenMP threads when running a hybrid program. Thus I strongly recommended to download the latest version of MPI.</p><h2 id="test-environment">Test Environment</h2><p>On the test platform, each machine contains <strong>2 NUMA nodes, 36 physical cores, 72 hardware threads</strong> overall. The test hybrid program could be downloaded from <a href="https://rcc.uchicago.edu/docs/running-jobs/hybrid/index.html">https://rcc.uchicago.edu/docs/running-jobs/hybrid/index.html</a>, and <strong>OpenMPI 4.0.2 and GCC 7.3.0</strong> are downloaded from Anaconda.</p><h2 id="map-by-unit">map-by unit</h2><p>This is the most fundamental syntax. And <code>unit</code> can be filled in <code>hwthread</code>, <code>core</code>, <code>L1cache</code>, <code>L2cache</code>, <code>L3cache</code>, <code>socket</code>, <code>numa</code>, <code>board</code>, <code>node</code>. Note that <code>hwthread</code> means hardware thread, while <code>core</code> means physical core. <code>numa</code> option is commonly used.</p><p>The following example illustrates the differences of each option. To make output clear, <code>PE=1</code> was added to limit thread numbers, and we will introduce it in the section <a href="#map-by%20unit:pe=n">map-by unit:pe=n</a>. <code>--report-bindings</code> is a proprietary option of OpenMPI to visualize bindings, and you can check <a href="#Appendix">Appendix</a> to figure out the similar usage of other MPI implementations.</p><h3 id="map-by-numa">map-by numa</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 --map-by numa:PE=1 --report-bindings ./a.out</span><br><span class="line">[asialab-01:69587] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69587] MCW rank 1 bound to socket 1[core 18[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69587] MCW rank 2 bound to socket 0[core 1[hwt 0-1]]: [../BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69587] MCW rank 3 bound to socket 1[core 19[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][../BB/../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 3 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="map-by-hwthread">map-by hwthread</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 --map-by hwthread:PE=1 --report-bindings ./a.out</span><br><span class="line">[asialab-01:69621] MCW rank 0 bound to socket 0[core 0[hwt 0]]: [B./../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69621] MCW rank 1 bound to socket 0[core 0[hwt 1]]: [.B/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69621] MCW rank 2 bound to socket 0[core 1[hwt 0]]: [../B./../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69621] MCW rank 3 bound to socket 0[core 1[hwt 1]]: [../.B/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 1 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 1 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="map-by-core">map-by core</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 --map-by core:PE=1 --report-bindings ./a.out</span><br><span class="line">[asialab-01:69653] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69653] MCW rank 1 bound to socket 0[core 1[hwt 0-1]]: [../BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69653] MCW rank 2 bound to socket 0[core 2[hwt 0-1]]: [../../BB/../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:69653] MCW rank 3 bound to socket 0[core 3[hwt 0-1]]: [../../../BB/../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 3 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><p>Observe that when we set to <code>map-by numa</code>, MPI will take NUMA architecture into consideration and balance the workload of two NUMA nodes. Otherwise, MPI will ignore NUMA.</p><p>You may notice that when <code>map-by</code> is set to <code>hwthread</code>, only one thread is allocated to OpenMP in each rank. The section <a href="#bind-to%20unit">bind-to unit</a> explains this to some degree.</p><h2 id="bind-to-unit">bind-to unit</h2><p>The default option is core if we didn't specify this option. Although this option is not so important, but there are several interesting concepts to learn. You may have heard the word <strong>slot</strong>, and you can imagine each slot will hold one rank at most. My understanding is that it is <strong>slot</strong> will be <strong>bound to</strong> specified units such as hardware threads or physical cores. Let us go through some examples.</p><h3 id="bind-to-hwthread">bind-to hwthread</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 --bind-to hwthread --map-by numa --report-bindings ./a.out</span><br><span class="line">[asialab-01:71905] MCW rank 0 bound to socket 0[core 0[hwt 0]]: [B./../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:71905] MCW rank 1 bound to socket 1[core 18[hwt 0]]: [../../../../../../../../../../../../../../../../../..][B./../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:71905] MCW rank 2 bound to socket 0[core 0[hwt 1]]: [.B/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:71905] MCW rank 3 bound to socket 1[core 18[hwt 1]]: [../../../../../../../../../../../../../../../../../..][.B/../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 1 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 0 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-core">bind-to core</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 --bind-to core --map-by numa --report-bindings ./a.out</span><br><span class="line">[asialab-01:71922] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:71922] MCW rank 1 bound to socket 1[core 18[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:71922] MCW rank 2 bound to socket 0[core 1[hwt 0-1]]: [../BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:71922] MCW rank 3 bound to socket 1[core 19[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][../BB/../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 3 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-numa">bind-to numa</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 2 --bind-to numa --map-by numa --report-bindings ./a.out</span><br><span class="line">[asialab-01:72100] MCW rank 0 bound to socket 0[core 0[hwt 0-1]], socket 0[core 1[hwt 0-1]], socket 0[core 2[hwt 0-1]], socket 0[core 3[hwt 0-1]], socket 0[core 4[hwt 0-1]], socket 0[core 5[hwt 0-1]], socket 0[core 6[hwt 0-1]], socket 0[core 7[hwt 0-1]], socket 0[core 8[hwt 0-1]], socket 0[core 9[hwt 0-1]], socket 0[core 10[hwt 0-1]], socket 0[core 11[hwt 0-1]], socket 0[core 12[hwt 0-1]], socket 0[core 13[hwt 0-1]], socket 0[core 14[hwt 0-1]], socket 0[core 15[hwt 0-1]], socket 0[core 16[hwt 0-1]], socket 0[core 17[hwt 0-1]]: [BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:72100] MCW rank 1 bound to socket 1[core 18[hwt 0-1]], socket 1[core 19[hwt 0-1]], socket 1[core 20[hwt 0-1]], socket 1[core 21[hwt 0-1]], socket 1[core 22[hwt 0-1]], socket 1[core 23[hwt 0-1]], socket 1[core 24[hwt 0-1]], socket 1[core 25[hwt 0-1]], socket 1[core 26[hwt 0-1]], socket 1[core 27[hwt 0-1]], socket 1[core 28[hwt 0-1]], socket 1[core 29[hwt 0-1]], socket 1[core 30[hwt 0-1]], socket 1[core 31[hwt 0-1]], socket 1[core 32[hwt 0-1]], socket 1[core 33[hwt 0-1]], socket 1[core 34[hwt 0-1]], socket 1[core 35[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB/BB]</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>If each slot is bound to a hardware thread, only one thread could be allocated to OpenMP in each rank. If each slot is bound to a physical core, all the threads in a physical core could be allocated. If each slot is bound to a NUMA node, all the threads in a NUMA node could be allocated.</p><h2 id="map-by-unitpen">map-by unit:pe=n</h2><p>In the previous section we introduce the concept <strong>slot</strong>. By default, each slot is bound to one physical core. This section we will dig deep into <code>pe</code>, and it may refer to <code>processing element</code> according to a website. This concept is ambiguous, and my understanding is that <code>pe=n</code> determines the number of units that each slot will occupy. Here are some examples.</p><h3 id="bind-to-core-pe1">bind-to core, PE=1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 2 --bind-to core --map-by numa:PE=1 --report-bindings ./a.out</span><br><span class="line">[asialab-01:72668] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:72668] MCW rank 1 bound to socket 1[core 18[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 2 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 2 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-core-pe2">bind-to core, PE=2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 2 --bind-to core --map-by numa:PE=2 --report-bindings ./a.out</span><br><span class="line">[asialab-01:72700] MCW rank 0 bound to socket 0[core 0[hwt 0-1]], socket 0[core 1[hwt 0-1]]: [BB/BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:72700] MCW rank 1 bound to socket 1[core 18[hwt 0-1]], socket 1[core 19[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/BB/../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 4 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 2 out of 4 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 3 out of 4 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 1 out of 4 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 2 out of 4 from process 1 out of 2 on asialab-01</span><br><span class="line">Hello from thread 0 out of 4 from process 1 out of 2 on asialab-01</span><br><span class="line">Hello from thread 1 out of 4 from process 1 out of 2 on asialab-01</span><br><span class="line">Hello from thread 3 out of 4 from process 1 out of 2 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-hwthread-pe1">bind-to hwthread, PE=1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 2 --bind-to hwthread --map-by numa:PE=1 --report-bindings ./a.out</span><br><span class="line">[asialab-01:72729] MCW rank 0 bound to socket 0[core 0[hwt 0]]: [B./../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:72729] MCW rank 1 bound to socket 1[core 18[hwt 0]]: [../../../../../../../../../../../../../../../../../..][B./../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 1 from process 1 out of 2 on asialab-01</span><br><span class="line">Hello from thread 0 out of 1 from process 0 out of 2 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-hwthread-pe2">bind-to hwthread, PE=2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 2 --bind-to hwthread --map-by numa:PE=2 --report-bindings ./a.out</span><br><span class="line">[asialab-01:72740] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:72740] MCW rank 1 bound to socket 1[core 18[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 2 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 2 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 2 on asialab-01</span><br></pre></td></tr></table></figure><p>However, I failed to launch with the setting <code>-n 1 --bind-to numa --map-by node:PE=2</code>, and I expect that only one rank consumes all the resources (equivalent to <code>bind-to core, PE=36</code>, or <code>bind-to hwthread, PE=72</code>). Anyway, <code>pe=n</code> will work well when combining with <code>bind-to core</code> or <code>bind-to hwthread</code>.</p><h2 id="map-by-pprnunit">map-by ppr:n:unit</h2><p><code>ppr</code> is short for <code>processes per resource</code>. The <code>processes</code> here basically are equivalent to MPI Rank. This option actually limits the maximum number of ranks (number of slots) that each unit can hold. Let us verify this.</p><h3 id="bind-to-core-ppr4">bind-to core, ppr:4</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> mpirun -n 4 --bind-to core --map-by ppr:4:numa --report-bindings ./a.out</span><br><span class="line">[asialab-01:00520] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00520] MCW rank 1 bound to socket 0[core 1[hwt 0-1]]: [../BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00520] MCW rank 2 bound to socket 0[core 2[hwt 0-1]]: [../../BB/../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00520] MCW rank 3 bound to socket 0[core 3[hwt 0-1]]: [../../../BB/../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 3 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-core-ppr2">bind-to core, ppr:2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 --bind-to core --map-by ppr:2:numa --report-bindings ./a.out</span><br><span class="line">[asialab-01:00541] MCW rank 0 bound to socket 0[core 0[hwt 0-1]]: [BB/../../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00541] MCW rank 1 bound to socket 0[core 1[hwt 0-1]]: [../BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00541] MCW rank 2 bound to socket 1[core 18[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00541] MCW rank 3 bound to socket 1[core 19[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][../BB/../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 2 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 3 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 2 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 2 from process 0 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h3 id="bind-to-core-ppr1">bind-to core, ppr:1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> mpirun -n 4 --bind-to core --map-by ppr:1:numa --report-bindings ./a.out</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">Your job has requested more processes than the ppr <span class="keyword">for</span></span><br><span class="line">this topology can support:</span><br><span class="line"></span><br><span class="line">  App: ./a.out</span><br><span class="line">  Number of procs:  4</span><br><span class="line">  PPR: 1:numa</span><br><span class="line"></span><br><span class="line">Please revise the conflict and try again.</span><br><span class="line">--------------------------------------------------------------------------</span><br></pre></td></tr></table></figure><p>Since each NUMA node is limited to hold one MPI process at most, and there are two NUMA nodes overall, it is reasonable to fail to run the program with four ranks.</p><h2 id="map-by-pprnunitpen">map-by ppr:n:unit:pe=n</h2><p>This is complete form of <code>map-by</code>. There is nothing new, so you should be able to explain the following complex example. Hint: <code>-host hostname:-1</code> will let MPI detect the number of available slots on the remote machine automatically.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mpirun -n 4 -host asialab-01:-1,asialab-03:-1 --bind-to hwthread --map-by ppr:1:numa:pe=4 --report-bindings ./a.out</span><br><span class="line">[asialab-01:00614] MCW rank 0 bound to socket 0[core 0[hwt 0-1]], socket 0[core 1[hwt 0-1]]: [BB/BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-01:00614] MCW rank 1 bound to socket 1[core 18[hwt 0-1]], socket 1[core 19[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/BB/../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-03:73603] MCW rank 2 bound to socket 0[core 0[hwt 0-1]], socket 0[core 1[hwt 0-1]]: [BB/BB/../../../../../../../../../../../../../../../..][../../../../../../../../../../../../../../../../../..]</span><br><span class="line">[asialab-03:73603] MCW rank 3 bound to socket 1[core 18[hwt 0-1]], socket 1[core 19[hwt 0-1]]: [../../../../../../../../../../../../../../../../../..][BB/BB/../../../../../../../../../../../../../../../..]</span><br><span class="line">Hello from thread 0 out of 4 from process 2 out of 4 on asialab-03</span><br><span class="line">Hello from thread 2 out of 4 from process 2 out of 4 on asialab-03</span><br><span class="line">Hello from thread 3 out of 4 from process 2 out of 4 on asialab-03</span><br><span class="line">Hello from thread 0 out of 4 from process 3 out of 4 on asialab-03</span><br><span class="line">Hello from thread 2 out of 4 from process 3 out of 4 on asialab-03</span><br><span class="line">Hello from thread 1 out of 4 from process 3 out of 4 on asialab-03</span><br><span class="line">Hello from thread 3 out of 4 from process 3 out of 4 on asialab-03</span><br><span class="line">Hello from thread 1 out of 4 from process 2 out of 4 on asialab-03</span><br><span class="line">Hello from thread 0 out of 4 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 3 out of 4 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 4 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 2 out of 4 from process 0 out of 4 on asialab-01</span><br><span class="line">Hello from thread 1 out of 4 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 0 out of 4 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 2 out of 4 from process 1 out of 4 on asialab-01</span><br><span class="line">Hello from thread 3 out of 4 from process 1 out of 4 on asialab-01</span><br></pre></td></tr></table></figure><h2 id="appendix">Appendix</h2><h3 id="report-bindings">Report bindings</h3><ul><li>Intel MPI: <code>-print-rank-map</code></li><li>MVAPICH2: <code>MV2_SHOW_CPU_BINDING=1</code></li><li>OpenMPI: <code>--report-bindings</code></li></ul><h2 id="reference">Reference</h2><ul><li><a href="https://www.ibm.com/support/knowledgecenter/SSZTET_10.2/admin/smpi02_proc_affinity_mapping.html">https://www.ibm.com/support/knowledgecenter/SSZTET_10.2/admin/smpi02_proc_affinity_mapping.html</a></li><li><a href="https://stackoverflow.com/questions/28216897/syntax-of-the-map-by-option-in-openmpi-mpirun-v1-8">https://stackoverflow.com/questions/28216897/syntax-of-the-map-by-option-in-openmpi-mpirun-v1-8</a></li><li><a href="https://rcc.uchicago.edu/docs/running-jobs/hybrid/index.html">https://rcc.uchicago.edu/docs/running-jobs/hybrid/index.html</a></li><li><a href="https://www.intel.com/content/dam/www/public/us/en/documents/presentation/things-mpi-library.pdf">https://www.intel.com/content/dam/www/public/us/en/documents/presentation/things-mpi-library.pdf</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;This tutorial will introduce how to utilize &lt;code&gt;map-by&lt;/code&gt; option to deal with many complex scenarios such as running a hybrid MPI program (mixture of OpenMP and MPI).&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>WSLSSH X11 Forwarding</title>
    <link href="https://nekodaemon.com/2021/01/23/%E9%85%8D%E7%BD%AEWSL%E7%9A%84SSH-X11-Forwarding/"/>
    <id>https://nekodaemon.com/2021/01/23/%E9%85%8D%E7%BD%AEWSL%E7%9A%84SSH-X11-Forwarding/</id>
    <published>2021-01-23T06:35:09.000Z</published>
    <updated>2021-01-23T06:50:59.000Z</updated>
    
    <content type="html"><![CDATA[<p>SSHX11 ForwardingX11 ServerWSLWindowsX11 ServerWSLSSHX11 ForwardingChrome OSyyds</p><h2 id="windowsx11-server">WindowsX11 Server</h2><p><code>VcXsrv</code>X11 Server<a href="https://sourceforge.net/projects/vcxsrv/"></a></p><p><code>XLaunch</code><code>Multiple windows</code>-&gt;<code>Start no client</code>-&gt;<code>Disable access control</code>-&gt;<code>Save Configuration</code>-&gt;<code>Finish</code></p><h2 id="wsl">WSL</h2><p>WSL<code>~/.bashrc</code><code>export DISPLAY=0.0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> DISPLAY=localhost:0.0</span><br></pre></td></tr></table></figure><p><code>source ~/.bashrc</code>enjoy it</p><figure><img data-src="/images/pasted-62.png" alt="upload successful" /><figcaption>upload successful</figcaption></figure><h2 id=""></h2><ul><li><a href="https://superuser.com/questions/1332709/setting-up-x11-forwarding-over-ssh-on-windows-10-subsystem-for-linux">https://superuser.com/questions/1332709/setting-up-x11-forwarding-over-ssh-on-windows-10-subsystem-for-linux</a></li><li><a href="https://ddadaal.me/articles/run-gui-on-wsl2-with-x11-forwarding">https://ddadaal.me/articles/run-gui-on-wsl2-with-x11-forwarding</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;SSHX11 ForwardingX11 ServerWSLWindowsX11 ServerWSLSSHX11 ForwardingChrome OSyyds&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>version GLIBCXX_3.4.20 not found</title>
    <link href="https://nekodaemon.com/2021/01/22/%E4%BF%AE%E5%A4%8D%E9%94%99%E8%AF%AFversion-GLIBCXX-3-4-20-not-found%E7%9A%84%E6%80%9D%E8%B7%AF/"/>
    <id>https://nekodaemon.com/2021/01/22/%E4%BF%AE%E5%A4%8D%E9%94%99%E8%AF%AFversion-GLIBCXX-3-4-20-not-found%E7%9A%84%E6%80%9D%E8%B7%AF/</id>
    <published>2021-01-22T13:08:39.000Z</published>
    <updated>2021-01-23T06:23:18.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong></strong>Cent OSGCC4.8.5DGL<strong>Conda</strong>CMakeGCCG++<code>version GLIBCXX_3.4.20 not found</code></p><p>CondaGCC</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create and activate a Conda environment named DGL</span></span><br><span class="line">conda create -n dgl </span><br><span class="line">conda activate dgl </span><br><span class="line"></span><br><span class="line"><span class="comment"># Add a channel called Conda-Forge</span></span><br><span class="line">conda config --add channels conda-forge</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install the software</span></span><br><span class="line">conda install gxx_linux-64 gcc_linux-64 cmake</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify whether GCC is working</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CC</span> <span class="comment"># Should not be the default one (like /usr/bin/gcc)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$CXX</span></span><br></pre></td></tr></table></figure><h2 id=""></h2><p><code>import dgl</code>DGL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/__init__.py&quot;</span>, line 13, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from .backend import load_backend, backend_name</span><br><span class="line">  File <span class="string">&quot;/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/backend/__init__.py&quot;</span>, line 96, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    load_backend(get_preferred_backend())</span><br><span class="line">  File <span class="string">&quot;/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/backend/__init__.py&quot;</span>, line 41, <span class="keyword">in</span> load_backend</span><br><span class="line">    from .._ffi.base import load_tensor_adapter <span class="comment"># imports DGL C library</span></span><br><span class="line">  File <span class="string">&quot;/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/_ffi/base.py&quot;</span>, line 45, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    _LIB, _LIB_NAME, _DIR_NAME = _load_lib()</span><br><span class="line">  File <span class="string">&quot;/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/_ffi/base.py&quot;</span>, line 35, <span class="keyword">in</span> _load_lib</span><br><span class="line">    lib = ctypes.CDLL(lib_path[0])</span><br><span class="line">  File <span class="string">&quot;/work/gutz/miniconda3/envs/dgl/lib/python3.8/ctypes/__init__.py&quot;</span>, line 381, <span class="keyword">in</span> __init__</span><br><span class="line">    self._handle = _dlopen(self._name, mode)</span><br><span class="line">OSError: /lib64/libstdc++.so.6: version `GLIBCXX_3.4.20<span class="string">&#x27; not found (required by /work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/libdgl.so)</span></span><br></pre></td></tr></table></figure><h2 id=""></h2><p><code>libdgl.so</code><code>/lib64/libstdc++.so.6</code><code>/lib64/libstdc++.so.6</code></p><p>CondaG++CondaC++<code>ldd</code><code>readelf</code><code>libdgl.so</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ldd /work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/libdgl.so</span></span><br><span class="line">        linux-vdso.so.1 =&gt;  (0x00007ffde9722000)</span><br><span class="line">        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00002aac0673e000)</span><br><span class="line">        librt.so.1 =&gt; /lib64/librt.so.1 (0x00002aac06942000)</span><br><span class="line">        libgomp.so.1 =&gt; /work/gutz/miniconda3/envs/dgl/lib/libgomp.so.1 (0x00002aac05929000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00002aac06b4a000)</span><br><span class="line">        libstdc++.so.6 =&gt; /work/gutz/miniconda3/envs/dgl/lib/libstdc++.so.6 (0x00002aac05957000)</span><br><span class="line">        libm.so.6 =&gt; /lib64/libm.so.6 (0x00002aac06d66000)</span><br><span class="line">        libgcc_s.so.1 =&gt; /work/gutz/miniconda3/envs/dgl/lib/libgcc_s.so.1 (0x00002aac05acb000)</span><br><span class="line">        libc.so.6 =&gt; /lib64/libc.so.6 (0x00002aac07068000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00002aac058f6000)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -d /work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/libdgl.so</span></span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xc14ef8 contains 32 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [librt.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libstdc++.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libgcc_s.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]</span><br><span class="line"> 0x000000000000000e (SONAME)             Library soname: [libdgl.so]</span><br><span class="line"> 0x000000000000000f (RPATH)              Library rpath: [/work/gutz/miniconda3/envs/dgl/lib]</span><br><span class="line"> 0x000000000000000c (INIT)               0x19f000</span><br><span class="line"> 0x000000000000000d (FINI)               0xaae9c0</span><br><span class="line"> 0x0000000000000019 (INIT_ARRAY)         0xc10280</span><br><span class="line"> 0x000000000000001b (INIT_ARRAYSZ)       960 (bytes)</span><br><span class="line"> 0x0000000000000004 (HASH)               0x238</span><br><span class="line"> 0x000000006ffffef5 (GNU_HASH)           0xa0e8</span><br><span class="line"> 0x0000000000000005 (STRTAB)             0x45460</span><br><span class="line"> 0x0000000000000006 (SYMTAB)             0x15af0</span><br><span class="line"> 0x000000000000000a (STRSZ)              1191101 (bytes)</span><br><span class="line"> 0x000000000000000b (SYMENT)             24 (bytes)</span><br><span class="line"> 0x0000000000000003 (PLTGOT)             0xc16138</span><br><span class="line"> 0x0000000000000007 (RELA)               0x16c318</span><br><span class="line"> 0x0000000000000008 (RELASZ)             204672 (bytes)</span><br><span class="line"> 0x0000000000000009 (RELAENT)            24 (bytes)</span><br><span class="line"> 0x0000000000000018 (BIND_NOW)</span><br><span class="line"> 0x000000006ffffffb (FLAGS_1)            Flags: NOW</span><br><span class="line"> 0x000000006ffffffe (VERNEED)            0x16c098</span><br><span class="line"> 0x000000006fffffff (VERNEEDNUM)         9</span><br><span class="line"> 0x000000006ffffff0 (VERSYM)             0x16811e</span><br><span class="line"> 0x000000006ffffff9 (RELACOUNT)          1435</span><br><span class="line"> 0x0000000000000000 (NULL)               0x0</span><br></pre></td></tr></table></figure><p><code>libdgl.so</code>C++<code>/work/gutz/miniconda3/envs/dgl/lib/libstdc++.so.6</code><code>/lib64/libstdc++.so.6</code><code>readelf</code><code>RPATH</code>run-time search path<code>/work/gutz/miniconda3/envs/dgl/lib</code><strong></strong><strong></strong><code>/work/gutz/miniconda3/envs/dgl/lib/libstdc++.so.6</code><code>GLIBCXX_3.4.20</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># strings /work/gutz/miniconda3/envs/dgl/lib/libstdc++.so.6 | grep GLIBCXX</span></span><br><span class="line">...</span><br><span class="line">GLIBCXX_3.4.18</span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line">GLIBCXX_3.4.20</span><br><span class="line">GLIBCXX_3.4.21</span><br><span class="line">GLIBCXX_3.4.22</span><br><span class="line">GLIBCXX_3.4.23</span><br><span class="line">GLIBCXX_3.4.24</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>DGLC++DGL</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_load_lib</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Load libary by searching possible path.&quot;&quot;&quot;</span></span><br><span class="line">    lib_path = libinfo.find_lib_path()</span><br><span class="line">    lib = ctypes.CDLL(lib_path[<span class="number">0</span>]) <span class="comment"># lib_path[0] = &#x27;/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/dgl-0.6-py3.8-linux-x86_64.egg/dgl/libdgl.so&#x27;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>export LD_DEBUG=libs</code><code>/lib64/libstdc++.so.6</code>DGLPyTorch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">197196:      search path=/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/torch/lib               (RUNPATH from file /work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/torch/lib/libtorch_global_deps.so)</span><br><span class="line">197196:       trying file=/work/gutz/miniconda3/envs/dgl/lib/python3.8/site-packages/torch/lib/libgcc_s.so.1</span><br><span class="line">197196:      search cache=/etc/ld.so.cache</span><br><span class="line">197196:       trying file=/lib64/libgcc_s.so.1</span><br><span class="line">197196:</span><br><span class="line">197196:</span><br><span class="line">197196:     calling init: /lib64/libgcc_s.so.1</span><br><span class="line">197196:</span><br><span class="line">197196:</span><br><span class="line">197196:     calling init: /lib64/libstdc++.so.6</span><br></pre></td></tr></table></figure><p><code>ldd</code><code>libtorch_global_deps.so</code><code>/lib64/libstdc++.so.6</code><code>libdgl.so</code><code>/lib64/libstdc++.so.6</code><code>rpath</code>C++</p><p><code>readelf</code><code>libtorch_global_deps.so</code><code>rpath</code><code>$ORIGIN</code><code>libtorch_global_deps.so</code>PyTorchProfiling<code>libnvToolsExt</code>C++<code>/lib64/libstdc++.so.6</code></p><h2 id=""></h2><p>CondaG++PyTorch</p><p><code>patchelf</code><code>libtorch_global_deps.so</code>C++<code>rpath</code></p><p><code>LD_LIBRARY_PATH</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/work/gutz/miniconda3/envs/dgl/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure><h2 id=""></h2><ul><li><a href="http://shibing.github.io/2016/08/20/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E4%B8%8Erpath/">http://shibing.github.io/2016/08/20/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E4%B8%8Erpath/</a></li><li><a href="https://stackoverflow.com/questions/12851184/dlopen-failed-cannot-open-shared-object-file-no-such-file-or-directory">https://stackoverflow.com/questions/12851184/dlopen-failed-cannot-open-shared-object-file-no-such-file-or-directory</a></li><li><a href="https://nehckl0.medium.com/creating-relocatable-linux-executables-by-setting-rpath-with-origin-45de573a2e98">https://nehckl0.medium.com/creating-relocatable-linux-executables-by-setting-rpath-with-origin-45de573a2e98</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;&lt;/strong&gt;Cent OSGCC4.8.5DGL&lt;strong&gt;Conda&lt;/strong&gt;CMakeGCCG++&lt;code&gt;version GLIBCXX_3.4.20 not found&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
</feed>
